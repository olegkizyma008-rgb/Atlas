# ATLAS v5.0 - –Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –ë–∞–≥–∞—Ç–æ–∞–≥–µ–Ω—Ç–Ω–∞ –°–∏—Å—Ç–µ–º–∞

> **–í–µ—Ä—Å—ñ—è:** 5.0.3 (Pure MCP Mode + Intelligent Verification)  
> **–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** 22 –∂–æ–≤—Ç–Ω—è 2025  
> **–°—Ç–∞—Ç—É—Å:** Production Ready

**ATLAS v5.0** - —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –±–∞–≥–∞—Ç–æ–∞–≥–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑ –¥–∏–Ω–∞–º—ñ—á–Ω–∏–º MCP TODO workflow, JSON Schema –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é tools, **—ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ—é –¥–≤–æ–µ—Ç–∞–ø–Ω–æ—é –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é** (visual + MCP), —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é TTS/STT, —Ç–∞ 3D –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—î—é. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –≤ Pure MCP —Ä–µ–∂–∏–º—ñ –∑ Goose-inspired –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é.

## üéØ –û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

- **ü§ñ 3 AI –ê–≥–µ–Ω—Ç–∏** - Atlas, Tetyana, Grisha –∑ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏–º–∏ —Ä–æ–ª—è–º–∏
- **üîÑ MCP Dynamic TODO** - –∞–¥–∞–ø—Ç–∏–≤–Ω–µ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
- **üõ†Ô∏è 5 MCP –°–µ—Ä–≤–µ—Ä—ñ–≤** - filesystem, playwright, shell, applescript, memory
- **üîí JSON Schema Validation** - –∂–æ—Ä—Å—Ç–∫–µ –æ–±–º–µ–∂–µ–Ω–Ω—è LLM –Ω–∞ –≤–∞–ª—ñ–¥–Ω—ñ tool names (Goose-style)
- **üõ°Ô∏è Tetyana Tool System** - —Ä–æ–∑—à–∏—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è tools –∑ LLM –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
- **üîç Intelligent Verification** ‚≠ê NEW - –¥–≤–æ–µ—Ç–∞–ø–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è (LLM routing + visual/MCP)
- **üîÑ Smart Retry Logic** - 3 —Å–ø—Ä–æ–±–∏ –∑ exponential backoff —Ç–∞ intelligent fallbacks
- **üó£Ô∏è –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ TTS** - —Å–∏–Ω—Ç–µ–∑ –º–æ–≤–ª–µ–Ω–Ω—è –∑ Metal GPU acceleration
- **üéôÔ∏è Whisper STT** - —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–ª–µ–Ω–Ω—è (Large-v3, Metal)
- **üåê Web Interface** - 3D –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ —á–∞—Ç-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **‚ö° DI Container** - –º–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∑ lifecycle management

## üìã –ó–º—ñ—Å—Ç

- [–°–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–º–æ–≥–∏](#—Å–∏—Å—Ç–µ–º–Ω—ñ-–≤–∏–º–æ–≥–∏)
- [–®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç](#—à–≤–∏–¥–∫–∏–π-—Å—Ç–∞—Ä—Ç)
- [–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏](#–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º–∏)
- [–ü—Ä–æ—Ü–µ—Å –∑–∞–ø—É—Å–∫—É](#–ø—Ä–æ—Ü–µ—Å-–∑–∞–ø—É—Å–∫—É)
- [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏-—Å–∏—Å—Ç–µ–º–∏)
- [Tetyana Tool System](#tetyana-tool-system-new-v501) ‚≠ê NEW
- [Grisha Verification System](#grisha-verification-system-new-v503) ‚≠ê NEW
- [MCP Workflow](#mcp-workflow)
- [–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è](#–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è)
- [API —Ç–∞ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è](#api-—Ç–∞-—ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è)
- [–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è](#–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥-—Ç–∞-–ª–æ–≥—É–≤–∞–Ω–Ω—è)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç—É)

---

## –°–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–º–æ–≥–∏

### –û–±–æ–≤'—è–∑–∫–æ–≤—ñ
- **macOS** (Apple Silicon —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è Metal GPU)
- **Python 3.11+** - –¥–ª—è TTS —Ç–∞ Whisper —Å–µ—Ä–≤—ñ—Å—ñ–≤
- **Node.js 16+** - –¥–ª—è Orchestrator
- **npm** - –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö MCP –ø–∞–∫–µ—Ç—ñ–≤

### –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ
- **Metal GPU** - –¥–ª—è –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è TTS —Ç–∞ Whisper
- **8GB+ RAM** - –¥–ª—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
- **Mac Studio M1 Max** - –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è —Ü—ñ—î—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –ö—Ä–æ–∫ 1: –ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é

```bash
git clone <repository-url>
cd atlas4
```

### –ö—Ä–æ–∫ 2: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

```bash
# –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
cp .env.example .env

# –í—ñ–¥—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ .env —Ñ–∞–π–ª (–≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ LLM_API_ENDPOINT)
vim .env

# –ö–ª—é—á–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:
# LLM_API_ENDPOINT=http://localhost:4000/v1/chat/completions
# MCP_LLM_MODEL=atlas-gpt-4o-mini  # –î–ª—è LLM Tool Validator
# MCP_LLM_TEMPERATURE=0.1
# MCP_ITEM_MAX_ATTEMPTS=3  # Retry attempts –¥–ª—è tool planning
```

### –ö—Ä–æ–∫ 3: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
./setup-macos.sh

# –ê–±–æ –≤—Ä—É—á–Ω—É:
npm install                          # Root dependencies
cd orchestrator && npm install       # Orchestrator dependencies
python3 -m venv .venv               # Python virtual environment
source .venv/bin/activate
pip install -r requirements.txt

# –ì–ª–æ–±–∞–ª—å–Ω—ñ MCP –ø–∞–∫–µ—Ç–∏
npm install -g @modelcontextprotocol/server-filesystem
npm install -g @executeautomation/playwright-mcp-server
npm install -g super-shell-mcp
npm install -g @peakmojo/applescript-mcp
npm install -g @modelcontextprotocol/server-memory
```

### –ö—Ä–æ–∫ 4: –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
./restart_system.sh start

# –ê–±–æ —á–µ—Ä–µ–∑ npm
npm run start
```

### –ö—Ä–æ–∫ 5: –î–æ—Å—Ç—É–ø –¥–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

- **Web Interface**: http://localhost:5001
- **Orchestrator API**: http://localhost:5101
- **Health Check**: http://localhost:5101/health

### –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∏—Å—Ç–µ–º–æ—é

```bash
./restart_system.sh status     # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
./restart_system.sh stop       # –ó—É–ø–∏–Ω–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É
./restart_system.sh restart    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É
./restart_system.sh logs       # –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ª–æ–≥–∏
./restart_system.sh diagnose   # –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º–∏
./restart_system.sh clean      # –û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏
```

---

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏

### –í–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    USER (Browser/Voice)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Python Frontend (Flask) :5001                  ‚îÇ
‚îÇ  ‚Ä¢ Static files serving                                     ‚îÇ
‚îÇ  ‚Ä¢ 3D GLB visualization                                     ‚îÇ
‚îÇ  ‚Ä¢ WebSocket proxy                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ HTTP/WebSocket
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Node.js Orchestrator (Express) :5101                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  DI Container (Dependency Injection)                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Service Registry                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Lifecycle Management (onInit/onStart/onStop)       ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Core Services                                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Logger          ‚Ä¢ Config         ‚Ä¢ Telemetry       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Error Handler   ‚Ä¢ Sessions       ‚Ä¢ Network Config  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  MCP Workflow Services                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ MCPManager        ‚Ä¢ MCPTodoManager                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ TTSSyncManager    ‚Ä¢ VisionAnalysis                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ TetyanaToolSystem (NEW: JSON Schema + LLM Guard)   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Stage Processors (9 processors)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ModeSelection     ‚Ä¢ TodoPlanning                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ServerSelection   ‚Ä¢ PlanTools                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ExecuteTools      ‚Ä¢ VerifyItem (NEW: 4 sub-stages) ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ ReplanTodo        ‚Ä¢ FinalSummary                   ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Grisha Verification System (NEW v5.0.3)              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Heuristic Strategy    ‚Ä¢ LLM Eligibility Routing    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Visual Verification   ‚Ä¢ MCP Verification           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Smart Fallback (visual ‚Üí MCP)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  API Routes                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /chat/stream      ‚Ä¢ /health                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ /session/*        ‚Ä¢ /tts/*                         ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-‚îò
           ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ
           ‚ñº            ‚ñº            ‚ñº            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LLM API      ‚îÇ ‚îÇ TTS     ‚îÇ ‚îÇ Whisper ‚îÇ ‚îÇ MCP Servers  ‚îÇ
‚îÇ :4000        ‚îÇ ‚îÇ :3001   ‚îÇ ‚îÇ :3002   ‚îÇ ‚îÇ (stdio)      ‚îÇ
‚îÇ              ‚îÇ ‚îÇ         ‚îÇ ‚îÇ         ‚îÇ ‚îÇ              ‚îÇ
‚îÇ ‚Ä¢ OpenRouter ‚îÇ ‚îÇ ‚Ä¢ Metal ‚îÇ ‚îÇ ‚Ä¢ Metal ‚îÇ ‚îÇ ‚Ä¢ filesystem ‚îÇ
‚îÇ ‚Ä¢ Local LLM  ‚îÇ ‚îÇ ‚Ä¢ GPU   ‚îÇ ‚îÇ ‚Ä¢ GPU   ‚îÇ ‚îÇ ‚Ä¢ playwright ‚îÇ
‚îÇ              ‚îÇ ‚îÇ         ‚îÇ ‚îÇ         ‚îÇ ‚îÇ ‚Ä¢ shell      ‚îÇ
‚îÇ              ‚îÇ ‚îÇ         ‚îÇ ‚îÇ         ‚îÇ ‚îÇ ‚Ä¢ applescript‚îÇ
‚îÇ              ‚îÇ ‚îÇ         ‚îÇ ‚îÇ         ‚îÇ ‚îÇ ‚Ä¢ memory     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢—Ä—å–æ—Ö–∞–≥–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞

**ATLAS** (–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)
- –ê–Ω–∞–ª—ñ–∑—É—î –∑–∞–ø–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –°—Ç–≤–æ—Ä—é—î –¥–∏–Ω–∞–º—ñ—á–Ω—ñ TODO –ø–ª–∞–Ω–∏
- –ö–æ—Ä–∏–≥—É—î –ø–ª–∞–Ω–∏ –ø—Ä–∏ –Ω–µ–≤–¥–∞—á–∞—Ö
- –ü—Ä–∏–π–º–∞—î —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ replan/skip/abort

**TETYANA** (–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å)
- –ü—ñ–¥–±–∏—Ä–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ MCP —Å–µ—Ä–≤–µ—Ä–∏
- –ü–ª–∞–Ω—É—î tool_calls –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ TODO –ø—É–Ω–∫—Ç—É
- –í–∏–∫–æ–Ω—É—î tools —á–µ—Ä–µ–∑ MCP protocol
- –†–æ–±–∏—Ç—å screenshots —Ç–∞ adjustments

**GRISHA** (–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ç–æ—Ä) ‚≠ê UPDATED v5.0.3
- **–î–≤–æ–µ—Ç–∞–ø–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è**: Heuristic Strategy + LLM Eligibility Routing
- **Visual verification (2 —Å–ø—Ä–æ–±–∏ –∑ –µ—Å–∫–∞–ª–∞—Ü—ñ—î—é –º–æ–¥–µ–ª–µ–π)**:
  - –°–ø—Ä–æ–±–∞ 1: Llama-3.2-11B Vision (—à–≤–∏–¥–∫–∞, ~1s)
  - –°–ø—Ä–æ–±–∞ 2: Llama-3.2-90B Vision (—Ç–æ—á–Ω–∞, ~2s)
  - –Ø–∫—â–æ –æ–±–∏–¥–≤—ñ –Ω–µ–≤–¥–∞–ª—ñ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ MCP
- **MCP verification**: –í–∏–∫–æ–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ Tetyana processor (–Ω–∞—Ç–æ–ø—Ç–∞–Ω–∞ –¥–æ—Ä–æ–∂–∫–∞)
- **Intelligent routing**: Mistral 3B –≤–∏–±–∏—Ä–∞—î –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–π –º–µ—Ç–æ–¥ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- **Smart fallback**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ visual (2 —Å–ø—Ä–æ–±–∏) ‚Üí MCP —á–µ—Ä–µ–∑ LLM eligibility
- –ù–∞–¥–∞—î –¥–µ—Ç–∞–ª—å–Ω—ñ –∑–≤—ñ—Ç–∏ –ø—Ä–æ —É—Å–ø—ñ—Ö/–Ω–µ–≤–¥–∞—á—É –∑ evidence-based —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è–º–∏

---

## ‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å –∑–∞–ø—É—Å–∫—É

### –©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ `./restart_system.sh start`?

1. **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞** (.env —Ñ–∞–π–ª)
2. **–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π** (logs/, archive/)
3. **–ó–∞–ø—É—Å–∫ TTS Service** (Python, port 3001)
   - –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ukrainian-tts –º–æ–¥–µ–ª–µ–π
   - –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Metal GPU (MPS)
   - –ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞
4. **–ó–∞–ø—É—Å–∫ Whisper Service** (Python, port 3002)
   - –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è whisper.cpp binary
   - –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Large-v3 –º–æ–¥–µ–ª—ñ
   - Metal GPU acceleration (20+ layers)
5. **–ó–∞–ø—É—Å–∫ Orchestrator** (Node.js, port 5101)
   - DI Container initialization
   - –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
   - –ó–∞–ø—É—Å–∫ 6 MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤ (stdio)
   - Lifecycle hooks (onInit ‚Üí onStart)
6. **–ó–∞–ø—É—Å–∫ Frontend** (Python Flask, port 5001)
   - Serving static files
   - 3D GLB model loading
   - WebSocket proxy setup
7. **–ó–∞–ø—É—Å–∫ Recovery Bridge** (Python, port 5102)
8. **Health Check** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó MCP Servers

```javascript
// orchestrator/ai/mcp-manager.js
await mcpManager.initialize();
  ‚Üí spawn('npx', ['-y', '@modelcontextprotocol/server-filesystem'])
  ‚Üí spawn('npx', ['-y', '@executeautomation/playwright-mcp-server'])
  ‚Üí spawn('npx', ['-y', 'super-shell-mcp'])
  ‚Üí spawn('npx', ['-y', '@peakmojo/applescript-mcp'])
  ‚Üí spawn('npx', ['-y', '@modelcontextprotocol/server-memory'])
  
// –î–ª—è –∫–æ–∂–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:
1. Handshake (initialize message)
2. Wait for capabilities response
3. Request tools/list
4. Store tools in cache
```

---

## üîÑ MCP Workflow

### Dynamic TODO Execution Flow

```
User Request ‚Üí Mode Selection (Stage 0)
                    ‚Üì
            [CHAT MODE]  or  [TASK MODE]
                              ‚Üì
                    Atlas TODO Planning (Stage 1-MCP)
                    ‚îú‚îÄ Complexity: 1-10
                    ‚îú‚îÄ Mode: standard/extended
                    ‚îî‚îÄ Items: [{id, action, tools, ...}]
                              ‚Üì
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Item-by-Item Execution      ‚îÇ
              ‚îÇ   (for each TODO item)        ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
           Server Selection (Stage 2.0-MCP)
           ‚îú‚îÄ Filter relevant MCP servers
           ‚îî‚îÄ Optimize tool availability
                              ‚Üì
          Tetyana Plan Tools (Stage 2.1-MCP)
          ‚îú‚îÄ Select tools from filtered servers
          ‚îú‚îÄ Generate tool_calls array
          ‚îú‚îÄ Add tool history context
          ‚îî‚îÄ Validation with retry (3 attempts)
                             ‚Üì
      Visual Capture Mode Selector (Stage 2.1.5-MCP) ‚≠ê NEW
      ‚îú‚îÄ LLM –≤–∏–±–∏—Ä–∞—î —Ä–µ–∂–∏–º/—Ü—ñ–ª—å/–¥–∏—Å–ø–ª–µ–π –¥–ª—è —Å–∫—Ä—ñ–Ω—É
      ‚îî‚îÄ `VisualCaptureService` —Ñ—ñ–∫—Å—É—î —Å—Ç–∞–Ω –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º
                             ‚Üì
        Tetyana Execute Tools (Stage 2.2-MCP)
        ‚îú‚îÄ RepetitionInspector: Check for loops
        ‚îú‚îÄ LLMToolValidator: Safety validation üõ°Ô∏è
        ‚îú‚îÄ Execute each tool via MCP protocol
        ‚îú‚îÄ Collect execution results
        ‚îî‚îÄ Record in tool history
                              ‚Üì
         Grisha Verify Item (Stage 2.3-MCP) ‚≠ê UPDATED
         ‚îú‚îÄ Sub-stage 2.3.0: Visual Capture Mode Selector (per attempt) ‚≠ê NEW
         ‚îÇ   ‚îî‚îÄ LLM –≤–∏–∑–Ω–∞—á–∞—î —Ä–µ–∂–∏–º —Å–∫—Ä—ñ–Ω—É + fallback –¥–ª—è `VisualCaptureService`
         ‚îú‚îÄ Sub-stage 2.3.1: Heuristic Strategy
         ‚îÇ   ‚îî‚îÄ –®–≤–∏–¥–∫–∏–π –∞–Ω–∞–ª—ñ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ keywords
         ‚îú‚îÄ Sub-stage 2.3.2: LLM Eligibility Routing
         ‚îÇ   ‚îú‚îÄ Model: atlas-ministral-3b (temp 0.1)
         ‚îÇ   ‚îî‚îÄ Output: {recommended_path, additional_checks}
         ‚îú‚îÄ Sub-stage 2.3.3: Visual Verification (optional, 2 attempts)
         ‚îÇ   ‚îú‚îÄ Attempt 1: Llama-3.2-11B Vision (fast, ~1s)
         ‚îÇ   ‚îú‚îÄ Attempt 2: Llama-3.2-90B Vision (strong, ~2s)
         ‚îÇ   ‚îú‚îÄ If both fail ‚Üí re-run LLM Eligibility for MCP
         ‚îÇ   ‚îî‚îÄ Security checks (70% min confidence)
         ‚îú‚îÄ Sub-stage 2.3.4: MCP Verification (REFACTORED 2025-10-23)
         ‚îÇ   ‚îú‚îÄ Stage 2.0: Server Selection (–∑ hints –≤—ñ–¥ eligibility)
         ‚îÇ   ‚îú‚îÄ Stage 2.1: Tetyana Plan Tools (LLM + JSON Schema)
         ‚îÇ   ‚îú‚îÄ Stage 2.2: Tetyana Execute Tools (ValidationPipeline)
         ‚îÇ   ‚îî‚îÄ Grisha Analysis: _analyzeMcpResults() + –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
         ‚îî‚îÄ Return verified: true/false + confidence
                              ‚Üì
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ  Success?               ‚îÇ
                 ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                YES ‚îÇ                 ‚îÇ NO
                    ‚Üì                 ‚Üì
              Next Item      Grisha Deep Analysis (Stage 3.5)
                             ‚îú‚îÄ getDetailedAnalysisForAtlas()
                             ‚îú‚îÄ Failure analysis + suggestions
                             ‚îî‚îÄ Pass tetyanaData + grishaData to Atlas
                                      ‚Üì
                           Atlas Replan (Stage 3.6-MCP)
                           ‚îú‚îÄ Analyze tetyanaData + grishaData
                           ‚îú‚îÄ Decision: replan/skip/abort
                           ‚îú‚îÄ Strategy: retry/alternative/decompose
                           ‚îú‚îÄ Generate hierarchical child IDs (2 ‚Üí 2.1, 2.2) ‚≠ê NEW
                           ‚îî‚îÄ Insert new items if replanned
                                      ‚Üì
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  All Items Completed?       ‚îÇ
                         ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò
                        YES ‚îÇ                      ‚îÇ NO
                            ‚Üì                      ‚Üì
                   Final Summary          Continue Loop
                   (Stage 8-MCP)
```

### Hierarchical TODO IDs (NEW v5.0.5) ‚≠ê

–°–∏—Å—Ç–µ–º–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **—ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—ñ ID** –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ replanning:

```
1 ‚úÖ –í—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
2 üîÑ –ü–æ–º–Ω–æ–∂–∏—Ç–∏ 7*139 (failed)
  ‚Ü≥ 2.1 ‚úÖ –û—á–∏—Å—Ç–∏—Ç–∏ –¥–∏—Å–ø–ª–µ–π
  ‚Ü≥ 2.2 üîÑ –í–≤–µ—Å—Ç–∏ 7*139 (failed again!)
      ‚Ü≥ 2.2.1 ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ–Ω—à–∏–π –º–µ—Ç–æ–¥
      ‚Ü≥ 2.2.2 ‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–∫—Ä—ñ–Ω—à–æ—Ç–æ–º
  ‚Ü≥ 2.3 ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
3 ‚úÖ –í—ñ–¥–Ω—è—Ç–∏ 85 (—Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ –ø—ñ—Å–ª—è 2.1-2.3)
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω–∏—Ö ID:**
- **–í—ñ–∑—É–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** `2.2.1` = –¥–∏—Ç–∏–Ω–∞ `2.2`, —è–∫–∞ —î –¥–∏—Ç–∏–Ω–æ—é `2`
- **–ì–ª–∏–±–∏–Ω–∞ replanning:** –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫—Ä–∞–ø–æ–∫ = —Ä—ñ–≤–µ–Ω—å –≤–∫–ª–∞–¥–µ–Ω–æ—Å—Ç—ñ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π dependency tracking:** Item #3 –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ #2 ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–ª–æ–∫—É—î—Ç—å—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è 2.1, 2.2.1, 2.2.2, 2.3
- **–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –õ–µ–≥–∫–æ –∑–Ω–∞–π—Ç–∏ –¥–µ —Å–∏—Å—Ç–µ–º–∞ –∑–∞—Å—Ç—Ä—è–ª–∞ –≤ replan loop

**–Ü–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è:**
- `HierarchicalIdManager` utility (`orchestrator/workflow/utils/hierarchical-id-manager.js`)
- –ú–µ—Ç–æ–¥–∏: `generateChildId()`, `getChildren()`, `getDescendants()`, `parseId()`, `formatForDisplay()`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–∏ replanning –≤ `executor-v3.js`
- Enhanced dependency checking –¥–ª—è replanned parents

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** `/docs/fixes/HIERARCHICAL_ID_SYSTEM_2025-10-23.md`

### MCP Stage Processors

| Stage   | Processor                      | Agent   | Responsibility                                    |
| ------- | ------------------------------ | ------- | ------------------------------------------------- |
| 0       | `ModeSelectionProcessor`       | System  | Chat vs Task classification                       |
| 1-MCP   | `AtlasTodoPlanningProcessor`   | Atlas   | Create dynamic TODO list                          |
| 2.0-MCP | `ServerSelectionProcessor`     | System  | Filter relevant MCP servers                       |
| 2.1-MCP | `Tetyana–ülanToolsProcessor`    | Tetyana | Plan tool_calls with JSON Schema validation       |
| 2.2-MCP | `TetyanaExecuteToolsProcessor` | Tetyana | Execute tools via MCP with LLM safety validation  |
| 2.3-MCP | `GrishaVerifyItemProcessor`    | Grisha  | Intelligent verification (4 sub-stages) ‚≠ê UPDATED |
| 3.5     | Grisha Deep Analysis           | Grisha  | Detailed failure analysis for Atlas               |
| 3.6-MCP | `AtlasReplanTodoProcessor`     | Atlas   | Deep analysis & replan with Tetyana + Grisha data |
| 8-MCP   | `McpFinalSummaryProcessor`     | System  | Generate final summary                            |

---

## üß© –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

### Orchestrator Core

**DI Container** (`orchestrator/core/di-container.js`)
- Dependency Injection –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
- Lifecycle management (onInit/onStart/onStop)
- Singleton pattern –¥–ª—è shared services
- Circular dependency detection

**Service Registry** (`orchestrator/core/service-registry.js`)
```javascript
// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤ –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
registerCoreServices(container)      // priority: 100-85
registerApiServices(container)       // priority: 60-50
registerStateServices(container)     // priority: 70
registerUtilityServices(container)   // priority: 45
registerMCPWorkflowServices(container) // priority: 55-50
registerMCPProcessors(container)     // priority: 45-40
```

**Application** (`orchestrator/core/application.js`)
- –ì–æ–ª–æ–≤–Ω–∏–π lifecycle manager
- Express app setup
- Routes configuration
- Graceful shutdown

### MCP Manager

**MCPManager** (`orchestrator/ai/mcp-manager.js`)
```javascript
class MCPManager {
  // –ó–∞–ø—É—Å–∫ MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤ —á–µ—Ä–µ–∑ stdio
  async initialize() {
    for (const [name, config] of servers) {
      const process = spawn(config.command, config.args);
      const server = new MCPServer(name, config, process);
      await server.initialize(); // handshake
      await server.requestToolsList(); // get available tools
    }
  }
  
  // –í–∏–∫–æ–Ω–∞–Ω–Ω—è tool —á–µ—Ä–µ–∑ MCP protocol
  async executeTool(serverName, toolName, parameters) {
    const server = this.servers.get(serverName);
    return await server.call(toolName, parameters);
  }
}
```

**TetyanaToolSystem** (`orchestrator/ai/tetyana-tool-system.js`) - NEW v5.0.1
```javascript
class TetyanaToolSystem {
  // Advanced tool management with validation
  async initialize() {
    this.extensionManager = new MCPExtensionManager(mcpManager);
    this.historyManager = new ToolHistoryManager({ maxSize: 100 });
    this.inspectionManager = new ToolInspectionManager();
    this.llmValidator = new LLMToolValidator(llmClient); // üõ°Ô∏è
  }
  
  // –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é
  async executeToolCalls(toolCalls, context) {
    // 1. Repetition check
    const repetitionCheck = await this.inspectionManager.inspectTools(toolCalls);
    if (repetitionCheck.denied) return { blocked: true };
    
    // 2. LLM Safety validation üõ°Ô∏è
    const validation = await this.llmValidator.validateToolCalls(toolCalls, context);
    if (validation.shouldBlock) return { blocked: true, reason: validation.summary };
    
    // 3. Execute
    const results = await this.dispatcher.dispatchToolCalls(toolCalls);
    
    // 4. Record history
    this.historyManager.recordCall(toolCall, result);
    
    return results;
  }
}
```

**MCPTodoManager** (`orchestrator/workflow/mcp-todo-manager.js`)
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö TODO —Å–ø–∏—Å–∫—ñ–≤
- Item-by-item –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- Retry logic –∑ adaptive adjustments
- TTS synchronization
- WebSocket chat updates

---

## üîç Grisha Verification System (NEW v5.0.3)

**–Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –¥–≤–æ–µ—Ç–∞–ø–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** –∑ LLM routing —Ç–∞ –ø–æ–≤–Ω–æ—é —É–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—î—é —á–µ—Ä–µ–∑ MCP workflow (Stage 2.0‚Üí2.1‚Üí2.2).

### –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å –∑ 10+ MCP Servers

**REFACTORED 2025-10-23**: Grisha —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–æ–≤–Ω–∏–π MCP workflow –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å:

**–ü–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Eligibility LLM (Mistral 3B)                                ‚îÇ
‚îÇ –í–∏–∑–Ω–∞—á–∞—î –©–û —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì (hints: server, tool, parameters)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Grisha —Å—Ç–≤–æ—Ä—é—î verification item                            ‚îÇ
‚îÇ { action, success_criteria, mcp_servers: [hint] }          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 2.0: Server Selection                                 ‚îÇ
‚îÇ –û–±–∏—Ä–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π server –∑ 5/10+ —Å–µ—Ä–≤–µ—Ä—ñ–≤                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì (selected_servers, selected_prompts)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 2.1: Tetyana Plan Tools                               ‚îÇ
‚îÇ –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–ø—Ç + JSON Schema                       ‚îÇ
‚îÇ TETYANA_PLAN_TOOLS_FILESYSTEM                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì (plan.tool_calls –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —ñ–º–µ–Ω–∞–º–∏)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 2.2: Tetyana Execute Tools                            ‚îÇ
‚îÇ ValidationPipeline ‚Üí MCPManager ‚Üí –í–∏–∫–æ–Ω–∞–Ω–Ω—è                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì (execution.results, execution.all_successful)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Grisha Analysis (_analyzeMcpResults)                        ‚îÇ
‚îÇ –ê–Ω–∞–ª—ñ–∑—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—Ä–æ—Ç–∏ success_criteria                 ‚îÇ
‚îÇ –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ tool result                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚Üì (verified: boolean, confidence: number, reason: string)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í–µ—Ä–¥–∏–∫—Ç ‚Üí Executor                                          ‚îÇ
‚îÇ ‚úÖ VERIFIED ‚Üí Next Item                                     ‚îÇ
‚îÇ ‚ùå NOT VERIFIED ‚Üí Replan –∞–±–æ Adjust                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

**–ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏:**
- ‚úÖ –ú–∞—Å—à—Ç–∞–±—É—î—Ç—å—Å—è –¥–æ –±—É–¥—å-—è–∫–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ MCP servers
- ‚úÖ –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø—Ä–æ–º–ø—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ server (TETYANA_PLAN_TOOLS_FILESYSTEM, etc.)
- ‚úÖ JSON Schema –≥–∞—Ä–∞–Ω—Ç—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç tool names
- ‚úÖ –£–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—è: verification –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π workflow —â–æ –π –æ—Å–Ω–æ–≤–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- ‚úÖ 1 –¢–µ—Ç—è–Ω–∞ –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è (–æ—Å–Ω–æ–≤–Ω–∞ + verification)
- ‚úÖ 2 –¢–µ—Ç—è–Ω–∏ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (–æ—Å–Ω–æ–≤–Ω–∞ + verification)

### Visual Capture Mode Selector (NEW v5.0.4)

–©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—å–æ–≤–∞–Ω–∏—Ö –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤ —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏–Ω–≥—É —Ç–∞ –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä —Ä–µ–∂–∏–º—É, –¢–µ—Ç—è–Ω–∞ –π –ì—Ä–∏—à–∞ —Ç–µ–ø–µ—Ä —Å–ø—ñ–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –ø—Ä–æ–º–ø—Ç `prompts/mcp/visual_capture_mode_selector.js`.

* __–©–æ —Ä–æ–±–∏—Ç—å –ø—Ä–æ–º–ø—Ç__
  - –∞–Ω–∞–ª—ñ–∑—É—î –∫–æ–Ω—Ç–µ–∫—Å—Ç TODO-–µ–ª–µ–º–µ–Ω—Ç–∞ (–∞–≥–µ–Ω—Ç, –æ–ø–∏—Å –¥—ñ—ó, –∫—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—Ö—É, –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Å–ø—Ä–æ–±–∏);
  - –ø–æ–≤–µ—Ä—Ç–∞—î —á–∏—Å—Ç–∏–π JSON —ñ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è `VisualCaptureService.captureScreenshot()`:
    `mode`, `target_app`, `display_number`, `require_retry`, `fallback_mode`, `reasoning`, `confidence`.
* __–î–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è__
  - `MCPTodoManager.screenshotAndAdjust()` (Stage 2.1.5) –≤–∏–∫–ª–∏–∫–∞—î —Å–µ–ª–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥ —Å–∫—Ä—ñ–Ω–æ–º –¥–ª—è –∫–æ—Ä–µ–∫—Ü—ñ—ó –ø–ª–∞–Ω—É –¢–µ—Ç—è–Ω–∏;
  - `GrishaVerifyItemProcessor._executeVisualVerification()` (Stage 2.3) –∑–∞–ø–∏—Ç—É—î —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –∫–æ–∂–Ω–æ—ó —Å–ø—Ä–æ–±–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ—ó –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –Ω–µ–≤–¥–∞—á.
* __–ß–∏–º –∑–∞–º—ñ–Ω–∏–≤ –ø–æ–ø–µ—Ä–µ–¥–Ω—î —Ä—ñ—à–µ–Ω–Ω—è__
  - –ø–æ–≤–Ω—ñ—Å—Ç—é –ø—Ä–∏–±—Ä–∞–Ω—ñ –æ–∫—Ä–µ–º—ñ Playwright/Shell —Å–∫—Ä—ñ–Ω—à–æ—Ç–∏ –∑ `MCPTodoManager`;
  - fallback-–ª–æ–≥—ñ–∫–∞ —Ç–µ–ø–µ—Ä —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞: —è–∫—â–æ –æ—Å–Ω–æ–≤–Ω–∏–π —Ä–µ–∂–∏–º –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `fallback_mode` –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–æ–º–ø—Ç–∞.
* __–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è__
  - –¥–ª—è —Å—Ç–∞–¥—ñ—ó `visual_capture_mode_selector` –¥–æ–¥–∞–Ω–æ –º–æ–¥–µ–ª—å —É `config/models-config.js` (—Ç–∏–ø–æ–≤–æ `atlas-ministral-3b`, temp 0.1, max_tokens 400);
  - —Å–µ—Ä–≤—ñ—Å `VisualCaptureService` –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —á–µ—Ä–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø—Ä–æ–º–ø—Ç–∞, —â–æ –≥–∞—Ä–∞–Ω—Ç—É—î –æ–¥–Ω–∞–∫–æ–≤—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É –¥–ª—è –æ–±–æ—Ö –∞–≥–µ–Ω—Ç—ñ–≤.

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

–ì—Ä–∏—à–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **4-–µ—Ç–∞–ø–Ω–∏–π –ø—Ä–æ—Ü–µ—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ:

#### –ï—Ç–∞–ø 1: Heuristic Strategy (–µ–≤—Ä–∏—Å—Ç–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑)
```javascript
// grisha-verification-strategy.js
class GrishaVerificationStrategy {
  determineStrategy(item, execution) {
    // –®–≤–∏–¥–∫–∏–π –∞–Ω–∞–ª—ñ–∑ –Ω–∞ –æ—Å–Ω–æ–≤—ñ keywords
    const visualIndicators = this._detectVisualIndicators(action, criteria);
    const filesystemIndicators = this._detectFilesystemIndicators(action, criteria);
    
    if (visualIndicators.score >= 70) {
      return { method: 'visual', confidence: 85, fallbackToMcp: true };
    }
    
    if (filesystemIndicators.score >= 60) {
      return { method: 'mcp', mcpServer: 'filesystem', confidence: 80 };
    }
    
    return { method: 'visual', confidence: 30, fallbackToMcp: true };
  }
}
```

**–î–µ—Ç–µ–∫—Ü—ñ—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤:**
- **Visual**: –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, safari, finder, –≤—ñ–∫–Ω–æ, –µ–∫—Ä–∞–Ω, —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- **Filesystem**: —Ñ–∞–π–ª, –ø–∞–ø–∫–∞, —Å—Ç–≤–æ—Ä–∏—Ç–∏, –∑–±–µ—Ä–µ–≥—Ç–∏, —ñ—Å–Ω—É—î
- **Shell**: –∫–æ–º–∞–Ω–¥–∞, —Å–∫—Ä–∏–ø—Ç, –ø—Ä–æ—Ü–µ—Å, –≤–∏–∫–æ–Ω–∞—Ç–∏
- **Memory**: –∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏, –∑–Ω–∞–Ω–Ω—è, —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

#### –ï—Ç–∞–ø 2: LLM Eligibility Routing (—ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä)
```javascript
// grisha-verification-eligibility-processor.js
// Model: atlas-ministral-3b (Mistral 3B)
// Temperature: 0.1 (–Ω–∏–∑—å–∫–∞ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—ñ)

const eligibilityResult = await this.callLLM({
  systemPrompt: GRISHA_VERIFICATION_ELIGIBILITY.SYSTEM_PROMPT,
  userPrompt: `
    TODO Item: ${item.action}
    Success Criteria: ${item.success_criteria}
    Execution Summary: ${executionSummary}
    Heuristic Signal: visual confidence ${heuristicConfidence}%
  `,
  model: 'atlas-ministral-3b',
  temperature: 0.1,
  max_tokens: 500
});

// Output:
{
  "visual_possible": true,
  "confidence": 85,
  "reason": "–§–∞–π–ª–æ–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è - –≤—ñ–∑—É–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ª–∞–±–∫–∞",
  "recommended_path": "data",  // 'visual' | 'data' | 'hybrid'
  "additional_checks": [
    {
      "description": "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ—Å–Ω—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—É calc_result.txt",
      "server": "filesystem",  // Hint –¥–ª—è Stage 2.0
      "tool": "filesystem__read_file",  // Hint (Stage 2.1 –º–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏)
      "parameters": { "path": "/Users/dev/Desktop/calc_result.txt" },
      "expected_evidence": "–§–∞–π–ª —ñ—Å–Ω—É—î —ñ –º—ñ—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç 18.68"
    }
  ]
}

// NOTE: additional_checks - —Ü–µ HINTS, –Ω–µ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –ø–ª–∞–Ω.
// Stage 2.0 (Server Selection) –≤–∞–ª—ñ–¥—É—î server
// Stage 2.1 (Tetyana Plan) –æ–±–∏—Ä–∞—î —Ñ—ñ–Ω–∞–ª—å–Ω—ñ tools —á–µ—Ä–µ–∑ LLM + JSON Schema
```

**LLM –ø—Ä–∏–π–º–∞—î —Ä—ñ—à–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ:**
- –¢–∏–ø—É –æ–ø–µ—Ä–∞—Ü—ñ—ó (UI vs —Ñ–∞–π–ª–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞)
- –ö—Ä–∏—Ç–µ—Ä—ñ—ó–≤ —É—Å–ø—ñ—Ö—É
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¢–µ—Ç—è–Ω–∏
- –ï–≤—Ä–∏—Å—Ç–∏—á–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤

#### –ï—Ç–∞–ø 3: Visual Verification (–≤—ñ–∑—É–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞)
```javascript
// –Ø–∫—â–æ recommended_path === 'visual' –∞–±–æ 'hybrid'

// 1. Capture screenshot
const screenshot = await this.visualCapture.captureScreenshot(
  `item_${item.id}_verify`,
  { targetApp: 'Calculator' }  // Window screenshot —è–∫—â–æ —î targetApp
);

// 2. Vision AI analysis
const visionAnalysis = await this.visionAnalysis.analyzeScreenshot(
  screenshot.filepath,
  item.success_criteria,
  { action: item.action, executionResults: execution.results }
);

// 3. Security checks
if (visionAnalysis._fallback === true) {
  verified = false;  // Reject fallback responses
}

if (visionAnalysis.visual_evidence?.matches_criteria !== true) {
  verified = false;  // Require explicit match
}

if (visionAnalysis.confidence < 70) {
  verified = false;  // Minimum 70% confidence
}
```

**Vision Models:**
- **Primary**: `atlas-llama-3.2-90b-vision-instruct` (Llama 3.2 90B Vision)
- **Fallback**: `atlas-llama-3.2-11b-vision-instruct` (Llama 3.2 11B Vision)
- **Local**: Ollama `llama3.2-vision` (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π, –ø–æ–≤—ñ–ª—å–Ω–∏–π)

**Security Features:**
- Fallback rejection (no unstructured responses)
- Explicit criteria matching validation
- Minimum confidence threshold (70%)
- Evidence validation logging

#### –ï—Ç–∞–ø 3: MCP Verification —á–µ—Ä–µ–∑ –ø–æ–≤–Ω–∏–π workflow (REFACTORED 2025-10-23)
```javascript
// –Ø–∫—â–æ recommended_path === 'data' –∞–±–æ 'hybrid'

// 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ verification item –∑ hints –≤—ñ–¥ Eligibility LLM
const verificationItem = {
  id: `verify_${currentItem.id}_${Date.now()}`,
  action: `–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${currentItem.action}`,
  success_criteria: currentItem.success_criteria,
  mcp_servers: eligibilityDecision?.additional_checks?.map(c => c.server) || []  // Hint
};

// 2. STAGE 2.0: Server Selection
const serverSelectionProcessor = this.container.resolve('serverSelectionProcessor');
const selectionResult = await serverSelectionProcessor.execute({
  currentItem: verificationItem,
  todo: { items: [currentItem] }
});
// ‚Üí –û–±–∏—Ä–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π server –∑ 5/10+ —Å–µ—Ä–≤–µ—Ä—ñ–≤
// ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î: selected_servers, selected_prompts

// 3. STAGE 2.1: Tetyana Plan Tools
const tetyanaPlanProcessor = this.container.resolve('tetyanaPlanToolsProcessor');
const planResult = await tetyanaPlanProcessor.execute({
  currentItem: verificationItem,
  selectedServers: selectionResult.selected_servers,
  selectedPrompts: selectionResult.selected_prompts
});
// ‚Üí –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –ø—Ä–æ–º–ø—Ç (TETYANA_PLAN_TOOLS_FILESYSTEM)
// ‚Üí JSON Schema –≥–∞—Ä–∞–Ω—Ç—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç: filesystem__get_file_info
// ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î: plan.tool_calls

// 4. STAGE 2.2: Tetyana Execute Tools
const tetyanaExecuteProcessor = this.container.resolve('tetyanaExecuteToolsProcessor');
const execResult = await tetyanaExecuteProcessor.execute({
  currentItem: verificationItem,
  plan: planResult.plan,
  todo: { items: [currentItem] },
  session: null,
  res: null
});
// ‚Üí ValidationPipeline: repetition check + LLM safety validation
// ‚Üí –í–∏–∫–æ–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ MCPManager
// ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î: execution.results, execution.all_successful

// 5. GRISHA ANALYSIS: –ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —ñ –≤–µ—Ä–¥–∏–∫—Ç
const verificationResults = execResult.execution;

// –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É
this.logger.system('grisha-verify-item', '[MCP-GRISHA] üìä Verification execution results:');
this.logger.system('grisha-verify-item', `  All successful: ${verificationResults.all_successful}`);
this.logger.system('grisha-verify-item', `  Tool count: ${verificationResults.results?.length}`);

verificationResults.results.forEach((result, idx) => {
  const status = result.success ? '‚úÖ' : '‚ùå';
  this.logger.system('grisha-verify-item', `  ${status} Tool ${idx + 1}: ${result.metadata?.tool}`);
  if (result.data) {
    this.logger.system('grisha-verify-item', `     Data: ${JSON.stringify(result.data).substring(0, 200)}`);
  }
});

// –ê–Ω–∞–ª—ñ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø—Ä–æ—Ç–∏ success_criteria
const verified = this._analyzeMcpResults(
  verificationResults,
  currentItem.success_criteria
);
// ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î: { success: boolean, confidence: number, reason: string }
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ MCP –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:**
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç–æ–π —Å–∞–º–∏–π –∫–æ–¥, —â–æ –π –¢–µ—Ç—è–Ω–∞ (Stage 2.2)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª—ñ–∫—É–≤–∞–Ω–Ω—è –ø—Ä–∏ —Ñ—ñ–∫—Å–∞—Ö –¢–µ—Ç—è–Ω–∏
- ‚úÖ –í—Å—ñ security checks —Ç–∞ validations
- ‚úÖ Tool history tracking
- ‚úÖ Repetition detection

### Smart Fallback System

**Visual ‚Üí MCP fallback:**
```javascript
if (!verification.verified && strategy.fallbackToMcp) {
  const mcpVerification = await this._executeMcpVerification(...);
  if (mcpVerification.verified) {
    verification = mcpVerification;  // Use MCP result
  }
}
```

**MCP ‚Üí Visual fallback** (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):
```javascript
if (!verification.verified && strategy.fallbackToVisual) {
  const visualVerification = await this._executeVisualVerification(...);
  if (visualVerification.verified) {
    verification = visualVerification;  // Use Visual result
  }
}
```

### –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

**Environment Variables (.env):**
```bash
# Grisha Verification Configuration
MCP_MODEL_VERIFICATION_ELIGIBILITY=atlas-ministral-3b
MCP_TEMP_VERIFICATION_ELIGIBILITY=0.1
```

**Agent Config (agents-config.js):**
```javascript
grisha: {
  verification: {
    methods: ['visual', 'mcp'],
    defaultMethod: 'visual',
    routing: {
      model: 'atlas-ministral-3b',
      temperature: 0.1
    },
    visual: {
      visionModel: 'atlas-llama-3.2-90b-vision-instruct',
      minConfidence: 70,
      captureDelay: 2000
    },
    mcp: {
      usesTetyanaProcessor: true,
      supportedServers: ['filesystem', 'shell', 'memory']
    },
    fallback: {
      visualToMcp: true,
      mcpToVisual: false
    }
  }
}
```

**Workflow Config (workflow-config.js):**
```javascript
GRISHA_VERIFY_ITEM: {
  stage: 5,
  subStages: [
    { id: 'VERIFICATION_STRATEGY', timeout: 5000 },
    { id: 'VERIFICATION_ELIGIBILITY', model: 'atlas-ministral-3b', timeout: 10000 },
    { id: 'VISUAL_VERIFICATION', optional: true, timeout: 30000 },
    { id: 'MCP_VERIFICATION', optional: true, timeout: 30000 }
  ]
}
```

### –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏

**–°—Ü–µ–Ω–∞—Ä—ñ–π 1: –§–∞–π–ª–æ–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è**
```
User: "–°—Ç–≤–æ—Ä–∏ —Ñ–∞–π–ª calc_result.txt –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º 18.68"

Heuristic Strategy:
  ‚Üí Detected: filesystem keywords (—Ñ–∞–π–ª, —Å—Ç–≤–æ—Ä–∏)
  ‚Üí Recommendation: MCP (confidence: 80%)

LLM Eligibility (Mistral 3B):
  ‚Üí Analysis: "–§–∞–π–ª–æ–≤–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è - –≤—ñ–∑—É–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ª–∞–±–∫–∞"
  ‚Üí Decision: recommended_path = "data"
  ‚Üí Additional checks: [filesystem__read_file]

MCP Verification:
  ‚Üí Execute: filesystem__read_file("/Users/dev/Desktop/calc_result.txt")
  ‚Üí Result: File exists, contains "18.68"
  ‚Üí Verified: ‚úÖ TRUE (confidence: 90%)
```

**–°—Ü–µ–Ω–∞—Ä—ñ–π 2: UI –æ–ø–µ—Ä–∞—Ü—ñ—è –∑ fallback**
```
User: "–í—ñ–¥–∫—Ä–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ñ –ø–æ—Ä–∞—Ö—É–π 5+3"

Heuristic Strategy:
  ‚Üí Detected: visual keywords (–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
  ‚Üí Recommendation: Visual (confidence: 90%)

LLM Eligibility (Mistral 3B):
  ‚Üí Analysis: "UI –æ–ø–µ—Ä–∞—Ü—ñ—è - –≤—ñ–∑—É–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞"
  ‚Üí Decision: recommended_path = "visual"
  ‚Üí Additional checks: []

Visual Verification:
  ‚Üí Screenshot: Calculator app window
  ‚Üí Vision AI: "Calculator is open, result shows 8"
  ‚Üí Verified: ‚úÖ TRUE (confidence: 85%)
```

---

## üõ°Ô∏è Tetyana Tool System (NEW v5.0.2)

**–†–æ–∑—à–∏—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è tools** –∑ JSON Schema –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é —Ç–∞ tracking —ñ—Å—Ç–æ—Ä—ñ—ó.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

**1. JSON Schema Validation** - Goose-inspired strict validation üîí
- –ì–µ–Ω–µ—Ä—É—î JSON Schema –∑ enum –≤–∞–ª—ñ–¥–Ω–∏—Ö tool names –∑ MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤
- LLM **—Ñ—ñ–∑–∏—á–Ω–æ –Ω–µ –º–æ–∂–µ** –≤–∏–≥–∞–¥–∞—Ç–∏ –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ –Ω–∞–∑–≤–∏ tools
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `response_format` –∑ `strict: true`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ —Ä—ñ–≤–Ω—ñ OpenAI API
- **100% –≥–∞—Ä–∞–Ω—Ç—ñ—è** —â–æ tool names –≤–∞–ª—ñ–¥–Ω—ñ

**2. ToolHistoryManager** - Tracking tool calls
- –ó–∞–ø–∏—Å—É—î –æ—Å—Ç–∞–Ω–Ω—ñ 100 –≤–∏–∫–ª–∏–∫—ñ–≤
- Success/failure rates per tool
- –§–æ—Ä–º–∞—Ç—É—î —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è LLM context
- –î–æ–ø–æ–º–∞–≥–∞—î Tetyana —É–Ω–∏–∫–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫

**3. RepetitionInspector** - Loop detection
- –î–µ—Ç–µ–∫—Ç—É—î consecutive repetitions (max 3)
- Tracking total calls per tool (max 10)
- **–ë–õ–û–ö–£–Ñ** –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—è
- Actions: ALLOW, DENY, REQUIRE_APPROVAL

**4. LLMToolValidator** - Safety validation üõ°Ô∏è
- –í–∞–ª—ñ–¥—É—î tool calls –ü–ï–†–ï–î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î –±–µ–∑–ø–µ–∫—É (dangerous paths, destructive commands)
- –ê–Ω–∞–ª—ñ–∑—É—î relevance –¥–æ user intent
- –û—Ü—ñ–Ω—é—î —Ä–∏–∑–∏–∫–∏: none/low/medium/high/critical
- **–ë–õ–û–ö–£–Ñ** high/critical risk operations

**5. ToolInspectionManager** - Coordination
- –ö–æ–æ—Ä–¥–∏–Ω—É—î –≤—Å—ñ inspectors
- –ê–≥—Ä–µ–≥—É—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
- Graceful error handling

### Tool Planning Flow –∑ JSON Schema

```javascript
// Stage 2.1: Tetyana Plan Tools

async planTools(item, availableTools) {
  // STEP 1: Build JSON Schema –∑ –≤–∞–ª—ñ–¥–Ω–∏–º–∏ tool names
  const toolSchema = {
    properties: {
      tool_calls: {
        items: {
          properties: {
            tool: {
              enum: ["filesystem__create_directory", "filesystem__write_file", ...]
            }
          }
        }
      }
    },
    strict: true
  };
  
  // STEP 2: LLM –∑–∞–ø–∏—Ç –∑ JSON Schema
  const response = await llm.chat({
    messages: [...],
    response_format: {
      type: 'json_schema',
      json_schema: { schema: toolSchema, strict: true }
    }
  });
  
  // STEP 3: –û—Ç—Ä–∏–º—É—î–º–æ –ì–ê–†–ê–ù–¢–û–í–ê–ù–û –≤–∞–ª—ñ–¥–Ω–∏–π JSON
  // LLM –Ω–µ –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ tool name –ø–æ–∑–∞ enum —Å–ø–∏—Å–∫–æ–º
  return response.tool_calls; // –ó–∞–≤–∂–¥–∏ –≤–∞–ª—ñ–¥–Ω—ñ!
}
```

### Execution Flow –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é

```javascript
// Stage 2.2: Tetyana Execute Tools

async executeToolCalls(toolCalls, context) {
  // STEP 1: Repetition check
  const repetitionCheck = await inspectionManager.inspectTools(toolCalls);
  if (repetitionCheck.denied) {
    return { blocked: true, reason: 'Loop detected' };
  }
  
  // STEP 2: LLM Safety validation üõ°Ô∏è
  const validation = await llmValidator.validateToolCalls(toolCalls, {
    userIntent: context.itemAction
  });
  
  if (validation.shouldBlock) {
    logger.error('üö´ BLOCKED:', validation.summary);
    return { 
      blocked: true, 
      reason: validation.summary,
      details: validation.highRisk 
    };
  }
  
  // STEP 3: Execute (—è–∫—â–æ –ø—Ä–æ–π—à–ª–∏ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)
  const results = await dispatcher.dispatchToolCalls(toolCalls);
  
  // STEP 4: Record in history
  historyManager.recordCall(toolCall, result);
  
  return results;
}
```

### –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

**‚úÖ –ë–µ–∑–ø–µ—á–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è:**
```javascript
Tool: filesystem__read_file { path: '/Users/dev/config.json' }
Validation: { valid: true, risk: 'none' }
‚Üí ‚úÖ –î–û–ó–í–û–õ–ï–ù–û
```

**üö´ –ù–µ–±–µ–∑–ø–µ—á–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è:**
```javascript
Tool: shell__run_command { command: 'rm -rf /' }
Validation: { 
  valid: false, 
  risk: 'critical',
  reasoning: 'Command will delete entire system'
}
‚Üí üö´ –ó–ê–ë–õ–û–ö–û–í–ê–ù–û
```

### –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

```bash
# .env
MCP_LLM_MODEL=atlas-gpt-4o-mini      # GPT-4o-mini –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ reasoning
MCP_LLM_TEMPERATURE=0.1              # –ù–∏–∑—å–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```javascript
const stats = tetyanaToolSystem.getStatistics();

{
  history: {
    totalCalls: 127,
    successRate: 0.77,
    uniqueTools: 15
  },
  inspection: {
    repetition: { denied: 3, allowed: 124 }
  },
  llmValidator: {
    totalValidations: 127,
    blocked: 3,
    blockRate: '2.36%'
  }
}
```

**Estimated Impact:**
- ‚úÖ **100% –≤–∞–ª—ñ–¥–Ω—ñ tool names** —á–µ—Ä–µ–∑ JSON Schema (–±—É–ª–æ: ~70% –∑ retry)
- ‚úÖ **0 –ø–æ–º–∏–ª–æ–∫** "tool not found" (–±—É–ª–æ: ~30% –ø–ª–∞–Ω—ñ–≤ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏)
- ‚úÖ 90%+ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π —á–µ—Ä–µ–∑ LLM Validator
- ‚úÖ 60-80% –∑–º–µ–Ω—à–µ–Ω–Ω—è –∑–∞—Ü–∏–∫–ª–µ–Ω—å —á–µ—Ä–µ–∑ RepetitionInspector
- ‚úÖ –°–µ–º–∞–Ω—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —á–µ—Ä–µ–∑ LLM reasoning

**–ö–ª—é—á–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è v5.0.2:**
- üîí JSON Schema validation (Goose-inspired)
- üîÑ Retry logic: 3 —Å–ø—Ä–æ–±–∏ (–±—É–ª–æ: 1)
- üìä Tool history tracking –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
- üõ°Ô∏è Multi-layer security (Schema + LLM + Repetition)

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** [`docs/LLM_VALIDATOR_CONFIG.md`](docs/LLM_VALIDATOR_CONFIG.md)

---

### Stage Processors

–ö–æ–∂–µ–Ω processor –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –æ–¥–∏–Ω –µ—Ç–∞–ø workflow:

```javascript
// –ü—Ä–∏–∫–ª–∞–¥: Tetyana–ülanToolsProcessor
class Tetyana–ülanToolsProcessor {
  async process(item, todo, context) {
    // 1. Get available tools from selected servers
    const tools = mcpManager.getToolsFromServers(context.selectedServers);
    
    // 2. Call LLM to plan tool_calls
    const plan = await this.callLLM({
      systemPrompt: TETYANA_PLAN_TOOLS_PROMPT,
      userMessage: { item, tools }
    });
    
    // 3. Validate tool_calls
    const validation = mcpManager.validateToolCalls(plan.tool_calls);
    
    // 4. Retry if invalid (max 3 attempts)
    if (!validation.valid) {
      return this.retryWithFeedback(validation.errors);
    }
    
    return plan;
  }
}
```

### Services

**TTS Service** (`ukrainian-tts/tts_server.py`)
- Ukrainian-TTS –º–æ–¥–µ–ª—å (robinhad/ukrainian-tts)
- 4 –≥–æ–ª–æ—Å–∏: dmytro, tetiana, mykyta, lada
- Metal GPU acceleration (MPS device)
- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è —Ñ—Ä–∞–∑ (phrase-filter)
- FX presets –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞

**Whisper Service** (`services/whisper/whispercpp_service.py`)
- Whisper.cpp Large-v3 –º–æ–¥–µ–ª—å
- Metal GPU offloading (20+ layers)
- WebM/Opus ‚Üí WAV –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è (PyAV)
- –ö–æ—Ä–µ–∫—Ü—ñ—è –∞–∫—Ç–∏–≤–∞—Ü—ñ–π–Ω–∏—Ö —Å–ª—ñ–≤ "–ê—Ç–ª–∞—Å"
- Initial prompt –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**Vision Analysis** (`orchestrator/services/vision-analysis-service.js`)
- GPT-4o vision (primary, ~2s)
- Atlas vision models (secondary)
- Screenshot analysis –¥–ª—è Grisha
- Automatic provider selection

### Multi-Agent Framework (Pure MCP)

–°–∏—Å—Ç–µ–º–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î MCP Dynamic TODO Workflow:

- **üß† ATLAS Agent** (–∑–µ–ª–µ–Ω–∏–π) - –°—Ç–≤–æ—Ä—é—î TODO –ø–ª–∞–Ω–∏ –∑ item-by-item —Ä–æ–∑–±–∏–≤–∫–æ—é
- **üí™ TETYANA Agent** (–±–ª–∞–∫–∏—Ç–Ω–∏–π) - –í–∏–∫–æ–Ω—É—î –∫–æ–∂–µ–Ω –ø—É–Ω–∫—Ç —á–µ—Ä–µ–∑ MCP tools
- **üõ°Ô∏è GRISHA Agent** (–∂–æ–≤—Ç–∏–π) - –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–∂–Ω–æ–≥–æ item –æ–∫—Ä–µ–º–æ

### MCP Workflow –µ—Ç–∞–ø–∏:
1. **Stage 0**: Mode Selection (chat vs task)
2. **Stage 1-MCP**: ATLAS - TODO Planning (—Å—Ç–≤–æ—Ä—é—î –¥–∏–Ω–∞–º—ñ—á–Ω–∏–π –ø–ª–∞–Ω)
3. **Stage 2.1-MCP**: TETYANA - Plan Tools (–ø—ñ–¥–±–∏—Ä–∞—î MCP tools)
4. **Stage 2.2-MCP**: TETYANA - Execute Tools (–≤–∏–∫–æ–Ω—É—î —á–µ—Ä–µ–∑ MCP)
5. **Stage 2.3-MCP**: GRISHA - Verify Item (–ø–µ—Ä–µ–≤—ñ—Ä—è—î –æ–∫—Ä–µ–º–∏–π item)
6. **Stage 3-MCP**: ATLAS - Adjust TODO (–∫–æ—Ä–∏–≥—É—î –ø—Ä–∏ failing)
7. **Stage 8-MCP**: Final Summary (–∑–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
4. **Stage 4**: TETYANA - –ü–æ–≤—Ç–æ—Ä–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑ —É—Ç–æ—á–Ω–µ–Ω–Ω—è–º–∏
5. **Stage 5**: GRISHA - –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (—è–∫—â–æ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è)
6. **Stage 6**: ATLAS - –ö–æ—Ä–µ–∫—Ü—ñ—è –∑–∞–≤–¥–∞–Ω–Ω—è  
7. **Stage 7**: GRISHA - –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ‚úÖ
8. **Stage 8**: SYSTEM - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è workflow
9. **Stage 9**: ATLAS - –ù–æ–≤–∏–π —Ü–∏–∫–ª (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)

## üéØ –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

### –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏:
- **Pure MCP —Ä–µ–∂–∏–º** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –≤–∏–∫–ª—é—á–Ω–æ —á–µ—Ä–µ–∑ MCP protocol
- **–ö–æ–Ω—Ç–µ–∫—Å—Ç-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** - 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —ñ—Å—Ç–æ—Ä—ñ—ó –≤ chat mode, 5 –≤ task mode
- **–í–∏—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º** - –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è exceptions –¥–ª—è —à–≤–∏–¥–∫–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **WebSocket —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è** - real-time –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è –º—ñ–∂ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### Ukrainian TTS —Å–∏—Å—Ç–µ–º–∞:
- **–ú–Ω–æ–∂–∏–Ω–Ω—ñ –≥–æ–ª–æ—Å–∏**: dmytro, tetiana, mykyta, oleksa
- **–†–µ–∞–ª—å–Ω–∏–π —Å–∏–Ω—Ç–µ–∑ –º–æ–≤–ª–µ–Ω–Ω—è** - –Ω–µ mock-—Ä–µ–∂–∏–º
- **–ì–æ–ª–æ—Å–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–≥–µ–Ω—Ç—ñ–≤** - –∫–æ–∂–µ–Ω –∞–≥–µ–Ω—Ç –º–∞—î —Å–≤—ñ–π –≥–æ–ª–æ—Å
- **Apple Silicon –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è** - MPS device –¥–ª—è –Ω–µ–π—Ä–æ–Ω–Ω–∏—Ö –º–µ—Ä–µ–∂

### –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è:
- **restart_system.sh** - —î–¥–∏–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏
- **config/global-config.js** - –≥–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π —Ñ–∞–π–ª (—î–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏)
- **–ú–æ–¥—É–ª—å–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥–∏** - agents-config.js, workflow-config.js, api-config.js
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –≤–±—É–¥–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

- macOS (Apple Silicon –∞–±–æ Intel)
- Python 3.9+
- Node.js 16+
- LLM API endpoint (local –∞–±–æ remote)

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. **–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ**
```bash
./install.sh
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É**
```bash
./restart_system.sh start
```

### –î–æ—Å—Ç—É–ø –¥–æ —Å–∏—Å—Ç–µ–º–∏
- **–í–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: http://localhost:5001
- **Orchestrator API**: http://localhost:5101
- **TTS Service**: http://localhost:3001
- **Whisper Service**: http://localhost:3002

### üí¨ –ì–æ–ª–æ—Å–æ–≤–µ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –º—ñ–∫—Ä–æ—Ñ–æ–Ω—É üîµ:

**Quick-send (—à–≤–∏–¥–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è):**
1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É üîµ **–æ–¥–∏–Ω —Ä–∞–∑**
2. –ì–æ–≤–æ—Ä—ñ—Ç—å (–º–∞–∫—Å. 30 —Å–µ–∫—É–Ω–¥)
3. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è

**Conversation (–∂–∏–≤–∏–π –¥—ñ–∞–ª–æ–≥):**
1. **–£—Ç—Ä–∏–º—É–π—Ç–µ** –∫–Ω–æ–ø–∫—É üîµ –ø—Ä–æ—Ç—è–≥–æ–º **2 —Å–µ–∫—É–Ω–¥**
2. –î–æ—á–µ–∫–∞–π—Ç–µ—Å—è –∑–µ–ª–µ–Ω–æ–≥–æ —Å–≤—ñ—Ç–ª–∞ üü¢
3. –°–∫–∞–∂—ñ—Ç—å **"–ê—Ç–ª–∞—Å"**
4. –ü–æ—á–Ω—ñ—Ç—å –¥—ñ–∞–ª–æ–≥ - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä–æ–∑–º–æ–≤—É

–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è: [`docs/CONVERSATION_MODE_QUICK_GUIDE.md`](docs/CONVERSATION_MODE_QUICK_GUIDE.md)

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

### –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (.env)

–í—Å—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ –∫–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `.env` —Ñ–∞–π–ª. –°–∫–æ–ø—ñ—é–π—Ç–µ `.env.example` –¥–æ `.env` —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ:

#### LLM API Configuration
```bash
# –û—Å–Ω–æ–≤–Ω–∏–π API endpoint (localhost –∞–±–æ ngrok)
LLM_API_ENDPOINT=http://localhost:4000/v1/chat/completions

# Secondary endpoint –¥–ª—è –≤—ñ–¥–¥–∞–ª–µ–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
LLM_API_FALLBACK_ENDPOINT=https://your-ngrok.ngrok-free.app/v1/chat/completions
LLM_API_USE_FALLBACK=false

# Timeout –¥–ª—è API –∑–∞–ø–∏—Ç—ñ–≤ (–º—Å)
LLM_API_TIMEOUT=60000
```

#### AI Backend & MCP Configuration
```bash
# –†–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏ (–∑–∞–≤–∂–¥–∏ 'mcp' –≤ v5.0)
AI_BACKEND_MODE=mcp

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –≤–∏–∫–æ–Ω–∞–Ω–Ω—è TODO item
MCP_ITEM_MAX_ATTEMPTS=3

# Timeout –¥–ª—è MCP –æ–ø–µ—Ä–∞—Ü—ñ–π
MCP_TIMEOUT_MS=30000

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è tools
MCP_TOOL_PLANNING_MAX_ATTEMPTS=3
```

#### MCP LLM Configuration (NEW v5.0.1)
```bash
# LLM Tool Validator (safety and validation)
MCP_LLM_MODEL=atlas-gpt-4o-mini
MCP_LLM_TEMPERATURE=0.1
```

#### MCP Models (Per-Stage Configuration)
```bash
# Stage 0: Mode Selection (task vs chat)
MCP_MODEL_MODE_SELECTION=atlas-ministral-3b
MCP_TEMP_MODE_SELECTION=0.05

# Stage 1: Atlas TODO Planning
MCP_MODEL_TODO_PLANNING=atlas-gpt-4o-mini
MCP_TEMP_TODO_PLANNING=0.3

# Stage 2.1: Tetyana Plan Tools
MCP_MODEL_PLAN_TOOLS=atlas-gpt-4o-mini
MCP_TEMP_PLAN_TOOLS=0.1

# Stage 2.3: Grisha Verify Item
MCP_MODEL_VERIFY_ITEM=atlas-mistral-small-2503
MCP_TEMP_VERIFY_ITEM=0.15

# Stage 8: Final Summary
MCP_MODEL_FINAL_SUMMARY=atlas-ministral-3b
MCP_TEMP_FINAL_SUMMARY=0.5
```

#### TTS Service
```bash
# –†–µ–∂–∏–º TTS (true = —Ä–µ–∞–ª—å–Ω–∏–π —Å–∏–Ω—Ç–µ–∑, false = mock)
REAL_TTS_MODE=true

# –ü—Ä–∏—Å—Ç—Ä—ñ–π –¥–ª—è TTS (mps = Metal GPU, cpu = CPU)
TTS_DEVICE=mps

# –ü–æ—Ä—Ç TTS —Å–µ—Ä–≤—ñ—Å—É
TTS_PORT=3001

# –ì–æ–ª–æ—Å–∏ –¥–ª—è –∞–≥–µ–Ω—Ç—ñ–≤
TTS_VOICE_ATLAS=dmytro
TTS_VOICE_TETYANA=tetiana
TTS_VOICE_GRISHA=mykyta
```

#### Whisper Service
```bash
# Backend –¥–ª—è Whisper (cpp = whisper.cpp, python = faster-whisper)
WHISPER_BACKEND=cpp

# –ü—Ä–∏—Å—Ç—Ä—ñ–π (metal = Metal GPU, cpu = CPU)
WHISPER_DEVICE=metal

# –ü–æ—Ä—Ç Whisper —Å–µ—Ä–≤—ñ—Å—É
WHISPER_PORT=3002

# Sample rate –¥–ª—è –∞—É–¥—ñ–æ
WHISPER_SAMPLE_RATE=48000

# –®–ª—è—Ö –¥–æ whisper.cpp binary
WHISPER_CPP_BIN=/path/to/whisper-cli

# –®–ª—è—Ö –¥–æ –º–æ–¥–µ–ª—ñ
WHISPER_CPP_MODEL=/path/to/ggml-large-v3.bin

# –ö—ñ–ª—å–∫—ñ—Å—Ç—å threads
WHISPER_CPP_THREADS=10

# –ö—ñ–ª—å–∫—ñ—Å—Ç—å GPU layers (0 = CPU only)
WHISPER_CPP_NGL=20

# –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
WHISPER_CPP_INITIAL_PROMPT="–¶–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ—ñ—î—é..."
```

#### Mac Studio M1 Max Optimizations
```bash
# –£–≤—ñ–º–∫–Ω—É—Ç–∏ Metal GPU acceleration
USE_METAL_GPU=true

# –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –¥–ª—è M1 Max
OPTIMIZE_FOR_M1_MAX=true

# Performance cores –¥–ª—è Whisper
WHISPER_CPP_THREADS=10

# GPU layers –¥–ª—è Metal
WHISPER_CPP_NGL=20
```

#### Service Ports
```bash
# Orchestrator API
ORCHESTRATOR_PORT=5101

# Frontend Web Server
WEB_PORT=5001
FRONTEND_PORT=5001

# TTS Service
TTS_PORT=3001

# Whisper Service
WHISPER_PORT=3002

# Recovery Bridge
RECOVERY_BRIDGE_PORT=5102
```

### –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏

**`config/atlas-config.js`** - –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä
- –Ü–º–ø–æ—Ä—Ç—É—î —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É—î –≤—Å—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
- –ó–∞–±–µ–∑–ø–µ—á—É—î —î–¥–∏–Ω—É —Ç–æ—á–∫—É –≤—Ö–æ–¥—É –¥–ª—è –≤—Å—ñ—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π
- –û–±'—î–¥–Ω—É—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑ —É—Å—ñ—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤

**–û—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–∞–π–ª–∏:**
- `config/system-config.js` - –°–∏—Å—Ç–µ–º–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- `config/agents-config.js` - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç—ñ–≤ (Atlas, Tetyana, Grisha)
- `config/workflow-config.js` - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è workflow —Ç–∞ —Å—Ç–∞–Ω—ñ–≤
- `config/api-config.js` - API endpoints —Ç–∞ –º–µ—Ä–µ–∂–µ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- `config/models-config.js` - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è AI –º–æ–¥–µ–ª–µ–π
- `config/security-config.js` - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
- `config/atlas-config.js` - –ì–æ–ª–æ–≤–Ω–∏–π –µ–∫—Å–ø–æ—Ä—Ç–Ω–∏–π —Ñ–∞–π–ª

**`config/agents-config.js`** - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç—ñ–≤
- Atlas (Coordinator)
- Tetyana (Executor)
- Grisha (Verifier)

**`config/workflow-config.js`** - Workflow –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
- Stages definitions
- Transitions
- Timeouts

**`config/api-config.js`** - API endpoints
- Network configuration
- Service ports
- Health check endpoints

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
atlas4/
‚îú‚îÄ‚îÄ restart_system.sh          # üéõÔ∏è –ì–æ–ª–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
‚îú‚îÄ‚îÄ README.md                  # üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –ø—Ä–æ–µ–∫—Ç—É
‚îú‚îÄ‚îÄ install.sh                 # üì¶ –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
‚îú‚îÄ‚îÄ web/                       # üåê Flask –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îî‚îÄ‚îÄ static/js/             # üì¶ –ú–æ–¥—É–ª—å–Ω–∏–π JavaScript
‚îÇ       ‚îú‚îÄ‚îÄ core/              # üîß –û—Å–Ω–æ–≤–Ω—ñ –º–æ–¥—É–ª—ñ (logger, config, api-client)
‚îÇ       ‚îú‚îÄ‚îÄ modules/           # üì± –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –º–æ–¥—É–ª—ñ (chat, tts)
‚îÇ       ‚îú‚îÄ‚îÄ app-refactored.js  # üöÄ –ì–æ–ª–æ–≤–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫
‚îÇ       ‚îî‚îÄ‚îÄ _unused/           # üóÉÔ∏è –ó–∞—Å—Ç–∞—Ä—ñ–ª—ñ —Ñ–∞–π–ª–∏
‚îú‚îÄ‚îÄ orchestrator/              # üé≠ Node.js —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∞–≥–µ–Ω—Ç–∞–º–∏ (–º–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞)
‚îÇ   ‚îú‚îÄ‚îÄ agents/                # ü§ñ –ö–ª—ñ—î–Ω—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ ai/                    # üß† AI –º–æ–¥—É–ª—ñ
‚îÇ   ‚îú‚îÄ‚îÄ utils/                 # üõ†Ô∏è –£—Ç–∏–ª—ñ—Ç–∏
‚îÇ   ‚îî‚îÄ‚îÄ workflow/              # üîÑ Workflow –ª–æ–≥—ñ–∫–∞
‚îú‚îÄ‚îÄ config/                    # ‚öôÔ∏è –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
‚îÇ   ‚îú‚îÄ‚îÄ global-config.js       # üîß –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥ (—î–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ)
‚îÇ   ‚îú‚îÄ‚îÄ agents-config.js       # ü§ñ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç—ñ–≤
‚îÇ   ‚îú‚îÄ‚îÄ workflow-config.js     # üîÑ –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è workflow
‚îÇ   ‚îî‚îÄ‚îÄ api-config.js          # üåê API endpoints
‚îú‚îÄ‚îÄ prompts/                   # üß† –ü—Ä–æ–º–ø—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤
‚îú‚îÄ‚îÄ ukrainian-tts/             # üîä TTS —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ docs/                      # üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏
‚îú‚îÄ‚îÄ scripts/                   # üõ†Ô∏è –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏
‚îú‚îÄ‚îÄ logs/                      # üìù –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
‚îî‚îÄ‚îÄ unused_files/              # üóÉÔ∏è –ê—Ä—Ö—ñ–≤ —Å—Ç–∞—Ä–∏—Ö —Ñ–∞–π–ª—ñ–≤
```

### –î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π

**`orchestrator/`** - Node.js Orchestrator (Express + DI Container)
```
orchestrator/
‚îú‚îÄ‚îÄ server.js                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ application.js          # Lifecycle manager
‚îÇ   ‚îú‚îÄ‚îÄ di-container.js         # Dependency Injection
‚îÇ   ‚îî‚îÄ‚îÄ service-registry.js     # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îú‚îÄ‚îÄ mcp-manager.js          # MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤ manager
‚îÇ   ‚îú‚îÄ‚îÄ llm-client.js           # LLM API client
‚îÇ   ‚îú‚îÄ‚îÄ llm-tool-selector.js    # LLM Tool Validator
‚îÇ   ‚îî‚îÄ‚îÄ tool-history-manager.js # Tool history tracking
‚îú‚îÄ‚îÄ workflow/
‚îÇ   ‚îú‚îÄ‚îÄ mcp-todo-manager.js     # Dynamic TODO workflow
‚îÇ   ‚îî‚îÄ‚îÄ processors/             # 9 stage processors
‚îú‚îÄ‚îÄ api/routes/
‚îÇ   ‚îú‚îÄ‚îÄ chat.routes.js          # Chat endpoints
‚îÇ   ‚îî‚îÄ‚îÄ web-integration.js      # Web integration
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ vision-analysis-service.js  # Vision models
‚îÇ   ‚îî‚îÄ‚îÄ tts-sync-manager.js    # TTS synchronization
‚îî‚îÄ‚îÄ utils/                      # Logger, telemetry, etc.
```

**`prompts/`** - –ü—Ä–æ–º–ø—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ (17 —Ñ–∞–π–ª—ñ–≤)
```
prompts/mcp/
‚îú‚îÄ‚îÄ stage0_mode_selection.js           # Chat vs Task
‚îú‚îÄ‚îÄ atlas_todo_planning_optimized.js   # TODO planning
‚îú‚îÄ‚îÄ atlas_replan_todo.js               # Replanning (Stage 3.6)
‚îú‚îÄ‚îÄ tetyana_plan_tools_*.js            # Tool planning (6 variants)
‚îú‚îÄ‚îÄ grisha_verify_item_optimized.js    # Verification
‚îú‚îÄ‚îÄ grisha_visual_verify_item.js       # Visual verification
‚îî‚îÄ‚îÄ mcp_final_summary.js               # Final summary
```

**`config/`** - –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
- `atlas-config.js` - –ì–æ–ª–æ–≤–Ω–∏–π –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π–Ω–∏–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä (–µ–∫—Å–ø–æ—Ä—Ç—É—î –≤—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è)
- `system-config.js` - –°–∏—Å—Ç–µ–º–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
- `agents-config.js` - 3 –∞–≥–µ–Ω—Ç–∏ –∑ —Ä–æ–ª—è–º–∏ —Ç–∞ –≥–æ–ª–æ—Å–∞–º–∏
- `workflow-config.js` - MCP stages –∑ transitions (0, 1-MCP, 2.0-2.3-MCP, 3-MCP, 3.5-MCP, 8-MCP)
- `api-config.js` - API endpoints —Ç–∞ –º–µ—Ä–µ–∂–µ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- `models-config.js` - –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è AI –º–æ–¥–µ–ª–µ–π —Ç–∞ vision
- `security-config.js` - –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

**`web/`** - Flask Frontend
- `atlas_server.py` - –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π Flask —Å–µ—Ä–≤–µ—Ä
- `static/` - 3D GLB –º–æ–¥–µ–ª—å, CSS, JavaScript
- `templates/index.html` - –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞

**`ukrainian-tts/`** - TTS —Å–∏—Å—Ç–µ–º–∞
- `tts_server.py` - Flask TTS API
- `vocoder/` - Ukrainian-TTS –º–æ–¥–µ–ª—ñ
- `fx_presets/` - FX –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∞–≥–µ–Ω—Ç—ñ–≤

**`services/whisper/`** - Whisper STT
- `whispercpp_service.py` - Whisper.cpp wrapper
- Metal GPU optimization

---

## üåê API —Ç–∞ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è

### Orchestrator API

**Base URL:** `http://localhost:5101`

**–ö–ª—é—á–æ–≤—ñ endpoints:**
- `POST /chat/stream` - –û–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (SSE)
- `POST /session/pause` - –ü—Ä–∏–∑—É–ø–∏–Ω–∏—Ç–∏ —Å–µ—Å—ñ—é
- `POST /session/resume` - –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Å–µ—Å—ñ—é
- `GET /health` - Health check
- `POST /tts/optimize` - –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è TTS

**WebSocket:** `ws://localhost:5101`
- Events: `chat_update`, `agent_message`, `tts_start`, `workflow_stage`

üìÑ **–ü–æ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** [`docs/API_REFERENCE.md`](docs/API_REFERENCE.md)

### TTS Service API

**Base URL:** `http://localhost:3001`
- `POST /synthesize` - –°–∏–Ω—Ç–µ–∑ –º–æ–≤–ª–µ–Ω–Ω—è (dmytro/tetiana/mykyta/lada)
- `GET /health` - Health check

### Whisper Service API

**Base URL:** `http://localhost:3002`
- `POST /transcribe` - –¢—Ä–∞–Ω—Å–∫—Ä–∏–±—É–≤–∞–Ω–Ω—è –∞—É–¥—ñ–æ
- `POST /transcribe_blob` - –¢—Ä–∞–Ω—Å–∫—Ä–∏–±—É–≤–∞–Ω–Ω—è blob
- `GET /health` - Health check

---

## üõ†Ô∏è MCP Tools

### 6 Active MCP Servers (92+ tools)

1. **Filesystem** (14 tools) - read_file, write_file, list_directory, search_files...
2. **Playwright** (32 tools) - navigate, click, screenshot, evaluate...
3. **Shell** (9 tools) - execute, execute_async, get_status, list_processes...
4. **AppleScript** (1 tool) - execute (macOS automation)
5. **Memory** (9 tools) - create_entity, add_observation, search...
6. **Git** (27 tools) - DISABLED (–Ω–µ—Å—Ç–∞–±—ñ–ª—å–Ω–∏–π)

### Tool Selection Flow
```
User Request
  ‚Üì
Stage 2.0: Server Selection (filter relevant servers)
  ‚Üì
Stage 2.1: Tetyana Plan Tools (select specific tools)
  ‚Üì
Stage 2.2: Tetyana Execute Tools (MCP protocol)
  ‚Üì
Stage 2.3: Grisha Verify (check results)
```

üìÑ **–ü–æ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:** [`docs/MCP_TOOLS_COMPLETE.md`](docs/MCP_TOOLS_COMPLETE.md)

---

## üß† –ü—Ä–æ–º–ø—Ç–∏ —Ç–∞ AI –ú–æ–¥–µ–ª—ñ

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç—ñ–≤ (17 –ø—Ä–æ–º–ø—Ç—ñ–≤)

**Atlas (Coordinator):**
- `atlas_todo_planning_optimized.js` - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏–Ω–∞–º—ñ—á–Ω–∏—Ö TODO –ø–ª–∞–Ω—ñ–≤
- `atlas_replan_todo.js` - –ì–ª–∏–±–æ–∫–∏–π –∞–Ω–∞–ª—ñ–∑ —Ç–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω (Stage 3.6)

**Tetyana (Executor):**
- `tetyana_plan_tools_*.js` - –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è tool_calls (6 –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤)
- `tetyana_screenshot_and_adjust.js` - Screenshots —Ç–∞ adjustments

**Grisha (Verifier):**
- `grisha_verify_item_optimized.js` - –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- `grisha_visual_verify_item.js` - –í—ñ–∑—É–∞–ª—å–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è

### AI Models Configuration

| Stage              | Model               | Temperature | Purpose                |
| ------------------ | ------------------- | ----------- | ---------------------- |
| 0 (Mode Selection) | atlas-ministral-3b  | 0.05        | Fast classification    |
| 1 (TODO Planning)  | copilot-gpt-4o      | 0.3         | Creative planning      |
| 2.1 (Plan Tools)   | copilot-gpt-4o      | 0.1         | Precise tool selection |
| 2.3 (Verify)       | copilot-gpt-4o-mini | 0.15        | Fast verification      |
| 3 (Adjust)         | copilot-gpt-4o-mini | 0.2         | Quick adjustments      |
| 8 (Summary)        | atlas-ministral-3b  | 0.5         | Creative summary       |

**Vision Models:**
- Primary: `atlas-gpt-4o` (GPT-4o with vision, ~2s)
- Secondary: Atlas vision models (phi-3.5-vision, llama-3.2-vision)

**–î–æ—Å—Ç—É–ø–Ω—ñ –º–æ–¥–µ–ª—ñ:** 50+ (GPT-4o, Mistral, DeepSeek, Claude, Cohere, Ollama)

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### –û—Å–Ω–æ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
- **README.md** (—Ü–µ–π —Ñ–∞–π–ª) - –ü–æ–≤–Ω–∏–π –æ–≥–ª—è–¥ —Å–∏—Å—Ç–µ–º–∏

### –î–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

**–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Ç–∞ Workflow:**
- [`docs/MCP_DYNAMIC_TODO_WORKFLOW_SYSTEM.md`](docs/MCP_DYNAMIC_TODO_WORKFLOW_SYSTEM.md) - –î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å MCP workflow
- [`docs/MCP_SERVERS_REFERENCE.md`](docs/MCP_SERVERS_REFERENCE.md) - –†–µ—Ñ–µ—Ä–µ–Ω—Å MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤
- [`docs/README.md`](docs/README.md) - –Ü–Ω–¥–µ–∫—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó

**API —Ç–∞ Tools:**
- [`docs/API_REFERENCE.md`](docs/API_REFERENCE.md) - –ü–æ–≤–Ω–∏–π API reference
- [`docs/MCP_TOOLS_COMPLETE.md`](docs/MCP_TOOLS_COMPLETE.md) - –í—Å—ñ MCP tools –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏

**–ê—Ä—Ö—ñ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:**
- `archive/docs-old/` - 260+ MD —Ñ–∞–π–ª—ñ–≤ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó —Ä–æ–∑—Ä–æ–±–∫–∏
- Fixes, refactorings, testing reports

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏

```bash
./restart_system.sh status    # –°—Ç–∞—Ç—É—Å –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
./restart_system.sh diagnose  # –ü–æ–≤–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
./restart_system.sh logs      # –ü–µ—Ä–µ–≥–ª—è–¥ –ª–æ–≥—ñ–≤
```

### –õ–æ–≥—É–≤–∞–Ω–Ω—è

–°–∏—Å—Ç–µ–º–∞ –≤–µ–¥–µ –¥–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –≤—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:

- `logs/orchestrator.log` - –õ–æ–≥–∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ç–∞ workflow
- `logs/frontend.log` - –õ–æ–≥–∏ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
- `logs/tts.log` - –õ–æ–≥–∏ TTS —Å–∏—Å—Ç–µ–º–∏
- `logs/whisper.log` - –õ–æ–≥–∏ Whisper —Å–µ—Ä–≤—ñ—Å—É

### –ö–æ–º–∞–Ω–¥–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –ü–æ–≤–Ω–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
./restart_system.sh diagnose

# –û—á–∏—â–µ–Ω–Ω—è –ª–æ–≥—ñ–≤
./restart_system.sh clean
```

## üîß –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ç–∞ –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

### –í—ñ–¥–æ–º—ñ –ø—Ä–æ–±–ª–µ–º–∏ —Ç–∞ —Ä—ñ—à–µ–Ω–Ω—è:

1. **LLM API timeout** - –∑–±—ñ–ª—å—à–µ–Ω–æ –¥–æ 120 —Å–µ–∫—É–Ω–¥
2. **Token limit exceeded** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–±—Ä—ñ–∑–∞–Ω–Ω—è –¥–æ 2000 —Å–∏–º–≤–æ–ª—ñ–≤
3. **Port conflicts** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –∑–∞–π–Ω—è—Ç–∏—Ö –ø–æ—Ä—Ç—ñ–≤
4. **MCP server crashes** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π restart —á–µ—Ä–µ–∑ DI container

### –î–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º:

1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏: `./restart_system.sh status`
2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `./restart_system.sh diagnose` 
3. –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ª–æ–≥–∏: `./restart_system.sh logs`
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∏—Å—Ç–µ–º—É: `./restart_system.sh restart`

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç—ñ–≤ —ñ workflow:
```bash
# –®–≤–∏–¥–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–æ–º–ø—Ç—ñ–≤
./scripts/validate-prompts.sh

# –î–µ—Ç–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
node scripts/audit-prompts.js

# –ê–Ω–∞–ª—ñ–∑ —è–∫–æ—Å—Ç—ñ –ø—Ä–æ–º–ø—Ç—ñ–≤
node scripts/analyze-prompts-quality.js

# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ñ —Ç–µ—Å—Ç–∏ (21 —Ç–µ—Å—Ç)
bash tests/test-all-prompts.sh
```

### –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ —Ç–µ—Å—Ç–∏:
```bash
# –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ç–∞ –ø–∞–º'—è—Ç—ñ
./tests/test-context.sh

# –¢–µ—Å—Ç mode selection (chat vs task)
./tests/test-mode-selection.sh

# –¢–µ—Å—Ç –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
./tests/test-security-features.sh

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å
./verify-fixes.sh
```

### –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏:
- ‚úÖ **21/21 —Ç–µ—Å—Ç—ñ–≤** –ø—Ä–æ—Ö–æ–¥—è—Ç—å
- ‚úÖ **92% —è–∫–æ—Å—Ç—ñ** –ø—Ä–æ–º–ø—Ç—ñ–≤
- ‚úÖ **6 MCP —Å—Ç–µ–π–¥–∂—ñ–≤** –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–æ–∫—Ä–∏—Ç—ñ
- ‚úÖ **100%** –ø–æ–∫—Ä–∏—Ç—Ç—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –±–µ–∑–ø–µ–∫–∏
- üìÑ –î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç: `docs/PROMPTS_WORKFLOW_AUDIT_REPORT.md`

## üîí Security Configuration (NEW v5.0.1)

### LLM Tool Validator
- **MCP_LLM_MODEL**: `atlas-gpt-4o-mini` (default)
- **MCP_LLM_TEMPERATURE**: `0.1` (low for consistency)
- **VALIDATION**: Always enabled for safety
- **RISK THRESHOLDS**:
  - Critical/High: Auto-blocked
  - Medium: Warning only
  - Low: Allowed with logging

### Security Features
- **Tool History**: Last 100 calls tracked
- **Repetition Detection**: Blocks after 3 consecutive identical calls
- **Rate Limiting**: 10 max calls per tool
- **Validation Fallback**: Safe mode on validation failure

### Environment Variables
```bash
# Enable/disable LLM validation
SECURITY_LLM_VALIDATOR_ENABLED=true

# Auto-block critical/high risk operations
SECURITY_AUTO_BLOCK_CRITICAL=true
SECURITY_AUTO_BLOCK_HIGH=true

# Tool history settings
SECURITY_TOOL_HISTORY_ENABLED=true
SECURITY_HISTORY_MAX_SIZE=100

# Repetition protection
SECURITY_REPETITION_CHECK_ENABLED=true
SECURITY_MAX_CONSECUTIVE_REPETITIONS=3
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### –û—Å–Ω–æ–≤–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
- **README.md** (—Ü–µ–π —Ñ–∞–π–ª) - –∑–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ç–∞ —à–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### –î–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è (–≤ docs/)

**–ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –í–∞–ª—ñ–¥–∞—Ü—ñ—è:**
- `docs/LLM_VALIDATOR_CONFIG.md` - –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è LLM Tool Validator
- `docs/SECURITY_IMPLEMENTATION.md` - –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏ –±–µ–∑–ø–µ–∫–∏

**–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:**
- `docs/ATLAS_SYSTEM_ARCHITECTURE.md` - –¥–µ—Ç–∞–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏
- `docs/MCP_WORKFLOW_SPEC.md` - —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è MCP workflow
- `docs/TECHNICAL_SPECIFICATION.md` - —Ç–µ—Ö–Ω—ñ—á–Ω–∞ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è

**–†–æ–∑—Ä–æ–±–∫–∞ —Ç–∞ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:**
- `docs/TESTING_INSTRUCTIONS.md` - —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- `docs/CONTRIBUTING.md` - —è–∫ –≤–Ω–µ—Å—Ç–∏ –≤–Ω–µ—Å–æ–∫ —É –ø—Ä–æ–µ–∫—Ç
- `docs/API_REFERENCE.md` - –ø–æ–≤–Ω–∏–π –æ–ø–∏—Å API

## License

This project is licensed under MIT License - see LICENSE file for details.

---

*ATLAS v5.0 - Adaptive Task and Learning Assistant System with Ukrainian TTS*
