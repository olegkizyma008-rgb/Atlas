# ATLAS v5.0 - –ê–Ω–∞–ª—ñ–∑ —Ä–æ–±–æ—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ –±–ª–æ—á–Ω–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º

> **–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 21 –∂–æ–≤—Ç–Ω—è 2025  
> **–í–µ—Ä—Å—ñ—è —Å–∏—Å—Ç–µ–º–∏:** 5.0.0 (Pure MCP Mode)  
> **–ê–≤—Ç–æ—Ä:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Å–∏—Å—Ç–µ–º–∏

---

## üìã –ó–º—ñ—Å—Ç

1. [–ó–∞–≥–∞–ª—å–Ω–∏–π –æ–≥–ª—è–¥ —Å–∏—Å—Ç–µ–º–∏](#–∑–∞–≥–∞–ª—å–Ω–∏–π-–æ–≥–ª—è–¥-—Å–∏—Å—Ç–µ–º–∏)
2. [–ë–ª–æ—á–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞](#–±–ª–æ—á–Ω–∞-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ê–ª–≥–æ—Ä–∏—Ç–º —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó](#–∞–ª–≥–æ—Ä–∏—Ç–º-—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
4. [–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É](#–∞–ª–≥–æ—Ä–∏—Ç–º-–æ–±—Ä–æ–±–∫–∏-–∑–∞–ø–∏—Ç—É)
5. [–î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä –±–ª–æ–∫—ñ–≤](#–¥–µ—Ç–∞–ª—å–Ω–∏–π-—Ä–æ–∑–±—ñ—Ä-–±–ª–æ–∫—ñ–≤)
6. [MCP Workflow Stages](#mcp-workflow-stages)
7. [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–∏—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–∏—Ö)

---

## üéØ –ó–∞–≥–∞–ª—å–Ω–∏–π –æ–≥–ª—è–¥ —Å–∏—Å—Ç–µ–º–∏

**ATLAS v5.0** - —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞ –±–∞–≥–∞—Ç–æ–∞–≥–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑ –º–æ–¥—É–ª—å–Ω–æ—é –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–æ—é, —â–æ –ø—Ä–∞—Ü—é—î –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–º **–±–ª–æ—á–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—ñ–≤** —á–µ—Ä–µ–∑ **MCP Dynamic TODO Workflow**.

### –ö–ª—é—á–æ–≤—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
- **–ú–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞** - Dependency Injection Container
- **–¢—Ä—å–æ—Ö–∞–≥–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞** - Atlas, Tetyana, Grisha
- **MCP Protocol** - 6 —Å–µ—Ä–≤–µ—Ä—ñ–≤ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
- **Pure MCP Mode** - –±–µ–∑ fallback –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤
- **–ë–ª–æ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞** - 9 stage processors
- **Lifecycle Management** - onInit ‚Üí onStart ‚Üí onStop

---

## üß± –ë–ª–æ—á–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫—ñ–≤ —Å–∏—Å—Ç–µ–º–∏:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 DI CONTAINER (–Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º–∏)                  ‚îÇ
‚îÇ  ‚Ä¢ Dependency Injection                                      ‚îÇ
‚îÇ  ‚Ä¢ Lifecycle Management (onInit/onStart/onStop)             ‚îÇ
‚îÇ  ‚Ä¢ Service Registry –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∞–º–∏                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ               ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  CORE   ‚îÇ    ‚îÇ   API   ‚îÇ    ‚îÇ  STATE  ‚îÇ
    ‚îÇ SERVICES‚îÇ    ‚îÇ SERVICES‚îÇ    ‚îÇ SERVICES‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ               ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ       MCP WORKFLOW SERVICES               ‚îÇ
    ‚îÇ  ‚Ä¢ MCPManager                             ‚îÇ
    ‚îÇ  ‚Ä¢ MCPTodoManager                         ‚îÇ
    ‚îÇ  ‚Ä¢ TTSSyncManager                         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ           ‚îÇ               ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ STAGE   ‚îÇ ‚îÇ STAGE  ‚îÇ    ‚îÇ STAGE   ‚îÇ
    ‚îÇ 0-MCP   ‚îÇ ‚îÇ 1-MCP  ‚îÇ... ‚îÇ 8-MCP   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ë–ª–æ–∫–∏ –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:

#### 1Ô∏è‚É£ **Core Services** (Priority: 100-85)
- **Logger** - —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- **Config** - –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏
- **Telemetry** - –º–µ—Ç—Ä–∏–∫–∏ —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- **ErrorHandler** - –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
- **NetworkConfig** - –º–µ—Ä–µ–∂–µ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

#### 2Ô∏è‚É£ **State Services** (Priority: 70)
- **Sessions** - —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–µ—Å—ñ—è–º–∏
- **WebSocketManager** - WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è

#### 3Ô∏è‚É£ **API Services** (Priority: 60-50)
- **LLMClient** - –∫–ª—ñ—î–Ω—Ç –¥–ª—è LLM API
- **FallbackLLM** - —Ä–µ–∑–µ—Ä–≤–Ω—ñ endpoints

#### 4Ô∏è‚É£ **MCP Workflow Services** (Priority: 55-50)
- **MCPManager** - —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è MCP —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- **MCPTodoManager** - –≤–∏–∫–æ–Ω–∞–Ω–Ω—è TODO —Å–ø–∏—Å–∫—ñ–≤
- **TTSSyncManager** - —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è TTS
- **VisionAnalysis** - –∞–Ω–∞–ª—ñ–∑ –∑–æ–±—Ä–∞–∂–µ–Ω—å

#### 5Ô∏è‚É£ **Stage Processors** (Priority: 45-40)
- 9 –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ—Ç–∞–ø—É workflow

---

## üöÄ –ê–ª–≥–æ—Ä–∏—Ç–º —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –§–∞–∑–∞ 1: –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏

```
START: ./restart_system.sh start
‚îÇ
‚îú‚îÄ‚ñ∫ [1] –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è .env —Ñ–∞–π–ª—É
‚îÇ     ‚îî‚îÄ‚ñ∫ –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (LLM_API_ENDPOINT, ports, models)
‚îÇ
‚îú‚îÄ‚ñ∫ [2] –ó–∞–ø—É—Å–∫ TTS Service (Python, port 3001)
‚îÇ     ‚îú‚îÄ‚ñ∫ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ukrainian-tts –º–æ–¥–µ–ª–µ–π
‚îÇ     ‚îú‚îÄ‚ñ∫ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Metal GPU (MPS device)
‚îÇ     ‚îî‚îÄ‚ñ∫ Flask —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤–∏–π
‚îÇ
‚îú‚îÄ‚ñ∫ [3] –ó–∞–ø—É—Å–∫ Whisper Service (Python, port 3002)
‚îÇ     ‚îú‚îÄ‚ñ∫ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è whisper.cpp binary
‚îÇ     ‚îú‚îÄ‚ñ∫ Large-v3 –º–æ–¥–µ–ª—å + Metal GPU
‚îÇ     ‚îî‚îÄ‚ñ∫ Flask —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤–∏–π
‚îÇ
‚îú‚îÄ‚ñ∫ [4] –ó–∞–ø—É—Å–∫ Orchestrator (Node.js, port 5101)
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.1] DI Container Initialization
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ registerCoreServices()
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ registerStateServices()
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ registerApiServices()
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ registerMCPWorkflowServices()
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ registerMCPProcessors()
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.2] container.initialize()
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ –í–∏–∫–ª–∏–∫ onInit() –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.3] Configuration Validation
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ AGENTS
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ WORKFLOW_STAGES
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ MCP_SERVERS
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.4] container.start()
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ –í–∏–∫–ª–∏–∫ onStart() –¥–ª—è –≤—Å—ñ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ MCPManager.initialize()
‚îÇ     ‚îÇ           ‚îú‚îÄ‚ñ∫ spawn MCP server: filesystem
‚îÇ     ‚îÇ           ‚îú‚îÄ‚ñ∫ spawn MCP server: playwright
‚îÇ     ‚îÇ           ‚îú‚îÄ‚ñ∫ spawn MCP server: shell
‚îÇ     ‚îÇ           ‚îú‚îÄ‚ñ∫ spawn MCP server: applescript
‚îÇ     ‚îÇ           ‚îî‚îÄ‚ñ∫ spawn MCP server: memory
‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ     ‚îÇ                 ‚îî‚îÄ‚ñ∫ –î–ª—è –∫–æ–∂–Ω–æ–≥–æ:
‚îÇ     ‚îÇ                       ‚îú‚îÄ‚ñ∫ Handshake
‚îÇ     ‚îÇ                       ‚îú‚îÄ‚ñ∫ Get capabilities
‚îÇ     ‚îÇ                       ‚îú‚îÄ‚ñ∫ Request tools/list
‚îÇ     ‚îÇ                       ‚îî‚îÄ‚ñ∫ Cache tools
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.5] Express App Setup
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ CORS configuration
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ Body parsing
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ Routes: /health, /chat/stream, /session/*, /tts/*
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.6] Session Cleanup Timer
‚îÇ     ‚îú‚îÄ‚ñ∫ [4.7] WebSocket Server (port 5102)
‚îÇ     ‚îî‚îÄ‚ñ∫ [4.8] HTTP Server Listen (port 5101)
‚îÇ
‚îú‚îÄ‚ñ∫ [5] –ó–∞–ø—É—Å–∫ Frontend (Python Flask, port 5001)
‚îÇ     ‚îú‚îÄ‚ñ∫ Static files serving
‚îÇ     ‚îú‚îÄ‚ñ∫ 3D GLB model loading
‚îÇ     ‚îî‚îÄ‚ñ∫ WebSocket proxy
‚îÇ
‚îî‚îÄ‚ñ∫ [6] Health Check

‚úÖ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê
```

---

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É

### –ë–ª–æ–∫-—Å—Ö–µ–º–∞ MCP Workflow:

```
USER REQUEST ‚Üí POST /chat/stream
‚îÇ
‚îú‚îÄ‚ñ∫ Session Management
‚îú‚îÄ‚ñ∫ SSE Stream Setup
‚îÇ
‚îî‚îÄ‚ñ∫ Execute MCP Workflow
      ‚îÇ
      ‚îú‚îÄ‚ñ∫ STAGE 0-MCP: Mode Selection
      ‚îÇ     Agent: System
      ‚îÇ     Model: atlas-ministral-3b
      ‚îÇ     Output: mode (chat/task), confidence
      ‚îÇ
      ‚îú‚îÄ‚ñ∫ IF mode = CHAT:
      ‚îÇ     ‚îî‚îÄ‚ñ∫ Simple conversational response
      ‚îÇ
      ‚îî‚îÄ‚ñ∫ IF mode = TASK:
            ‚îÇ
            ‚îú‚îÄ‚ñ∫ STAGE 1-MCP: Atlas TODO Planning
            ‚îÇ     Agent: Atlas (Coordinator)
            ‚îÇ     Model: copilot-gpt-4o
            ‚îÇ     Output: TodoList with items
            ‚îÇ
            ‚îî‚îÄ‚ñ∫ FOR EACH item in TodoList:
                  ‚îÇ
                  ‚îú‚îÄ‚ñ∫ STAGE 2.0-MCP: Server Selection
                  ‚îÇ     Output: selected_servers[]
                  ‚îÇ
                  ‚îú‚îÄ‚ñ∫ STAGE 2.1-MCP: Tetyana Plan Tools
                  ‚îÇ     Agent: Tetyana (Executor)
                  ‚îÇ     Output: tool_calls[]
                  ‚îÇ
                  ‚îú‚îÄ‚ñ∫ STAGE 2.2-MCP: Tetyana Execute Tools
                  ‚îÇ     Execute via MCP protocol
                  ‚îÇ     Output: execution_results
                  ‚îÇ
                  ‚îú‚îÄ‚ñ∫ STAGE 2.3-MCP: Grisha Verify Item
                  ‚îÇ     Agent: Grisha (Verifier)
                  ‚îÇ     Output: verified (true/false)
                  ‚îÇ
                  ‚îú‚îÄ‚ñ∫ IF verified = false:
                  ‚îÇ     ‚îÇ
                  ‚îÇ     ‚îú‚îÄ‚ñ∫ STAGE 3-MCP: Atlas Adjust TODO
                  ‚îÇ     ‚îÇ     Strategy: retry/alternative/skip
                  ‚îÇ     ‚îÇ     Max attempts: 3
                  ‚îÇ     ‚îÇ
                  ‚îÇ     ‚îî‚îÄ‚ñ∫ IF attempts >= 3:
                  ‚îÇ           ‚îî‚îÄ‚ñ∫ STAGE 3.5-MCP: Atlas Replan
                  ‚îÇ                 Decision: replan/skip/abort
                  ‚îÇ
                  ‚îî‚îÄ‚ñ∫ Continue to next item
            ‚îÇ
            ‚îî‚îÄ‚ñ∫ STAGE 8-MCP: Final Summary
                  Agent: Atlas
                  Output: summary, statistics

END RESPONSE
```

---

## üîç –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä –±–ª–æ–∫—ñ–≤

### –ë–õ–û–ö 1: DI Container

**–§–∞–π–ª:** `orchestrator/core/di-container.js`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```javascript
class DIContainer {
  // 1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
  register(name, factory, options) {
    // –ó–±–µ—Ä—ñ–≥–∞—î factory function —Ç–∞ metadata
    // options: { singleton, priority, lifecycle }
  }

  // 2. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (onInit phase)
  async initialize() {
    // –°–æ—Ä—Ç—É—î –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º (100 ‚Üí 40)
    for (service of sortedServices) {
      await service.lifecycle?.onInit();
    }
  }

  // 3. –ó–∞–ø—É—Å–∫ (onStart phase)
  async start() {
    for (service of sortedServices) {
      await service.lifecycle?.onStart();
    }
  }

  // 4. –†–µ–∑–æ–ª–≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
  resolve(name) {
    // –°—Ç–≤–æ—Ä—é—î –∞–±–æ –ø–æ–≤–µ—Ä—Ç–∞—î singleton instance
    return this.instances.get(name) || this.create(name);
  }
}
```

---

### –ë–õ–û–ö 2: MCPManager

**–§–∞–π–ª:** `orchestrator/ai/mcp-manager.js`

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è MCP —Å–µ—Ä–≤–µ—Ä–∞–º–∏ —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è tools

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```javascript
class MCPManager {
  // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤
  async initialize() {
    for (const [name, config] of servers) {
      // Spawn –ø—Ä–æ—Ü–µ—Å —á–µ—Ä–µ–∑ stdio
      const process = spawn(config.command, config.args);
      
      // –°—Ç–≤–æ—Ä–∏—Ç–∏ MCP —Å–µ—Ä–≤–µ—Ä
      const server = new MCPServer(name, config, process);
      
      // Handshake
      await server.initialize();
      
      // –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ tools
      await server.requestToolsList();
      
      // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ –∫–µ—à—ñ
      this.servers.set(name, server);
    }
  }

  // 2. –í–∏–∫–æ–Ω–∞–Ω–Ω—è tool
  async executeTool(serverName, toolName, parameters) {
    const server = this.servers.get(serverName);
    
    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ MCP request
    const result = await server.call(toolName, parameters);
    
    return result;
  }

  // 3. –í–∞–ª—ñ–¥–∞—Ü—ñ—è tool_calls
  validateToolCalls(toolCalls) {
    for (const call of toolCalls) {
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ server exists
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ tool exists
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ parameters schema
    }
  }
}
```

---

### –ë–õ–û–ö 3: MCPTodoManager

**–§–∞–π–ª:** `orchestrator/workflow/mcp-todo-manager.js`

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** Item-by-item –≤–∏–∫–æ–Ω–∞–Ω–Ω—è TODO —Å–ø–∏—Å–∫—ñ–≤

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```javascript
class MCPTodoManager {
  async executeItemByItem(todo, processors, context) {
    for (const item of todo.items) {
      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ dependencies
      if (!this.checkDependencies(item, todo)) {
        continue;
      }

      // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
      item.status = 'in_progress';

      // TTS: start phrase
      await this.tts.speak(item.tts.start, 'tetyana');

      // STAGE 2.0: Server Selection
      const selection = await processors.serverSelection.execute(item);

      // STAGE 2.1: Plan Tools
      const plan = await processors.planTools.execute(item, selection);

      // STAGE 2.2: Execute Tools
      const execution = await processors.executeTools.execute(plan);

      // STAGE 2.3: Verify Item
      const verification = await processors.verify.execute(item, execution);

      if (verification.verified) {
        item.status = 'completed';
        await this.tts.speak(item.tts.success, 'grisha');
      } else {
        // STAGE 3: Adjust TODO
        if (item.attempt < item.max_attempts) {
          await processors.adjust.execute(item, verification);
          item.attempt++;
          // Retry item
        } else {
          // STAGE 3.5: Replan
          await processors.replan.execute(item, todo, verification);
        }
      }
    }
  }
}
```

---

## üìä MCP Workflow Stages

### –¢–∞–±–ª–∏—Ü—è –µ—Ç–∞–ø—ñ–≤:

| Stage | Processor | Agent | Model | Temperature | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|-------|-----------|-------|-------|-------------|-------------|
| 0-MCP | ModeSelection | System | ministral-3b | 0.05 | Chat vs Task |
| 1-MCP | TodoPlanning | Atlas | gpt-4o | 0.3 | –°—Ç–≤–æ—Ä–µ–Ω–Ω—è TODO |
| 2.0-MCP | ServerSelection | System | gpt-4o-mini | 0.1 | –§—ñ–ª—å—Ç—Ä —Å–µ—Ä–≤–µ—Ä—ñ–≤ |
| 2.1-MCP | PlanTools | Tetyana | gpt-4o | 0.1 | –ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è tools |
| 2.2-MCP | ExecuteTools | Tetyana | N/A | N/A | –í–∏–∫–æ–Ω–∞–Ω–Ω—è MCP |
| 2.3-MCP | VerifyItem | Grisha | gpt-4o-mini | 0.15 | –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è |
| 3-MCP | AdjustTodo | Atlas | gpt-4o-mini | 0.2 | –ö–æ—Ä–µ–∫—Ü—ñ—è |
| 3.5-MCP | ReplanTodo | Atlas | gpt-4o | 0.3 | –ì–ª–∏–±–æ–∫–∏–π replan |
| 8-MCP | FinalSummary | Atlas | ministral-3b | 0.5 | –ü—ñ–¥—Å—É–º–æ–∫ |

---

## üîÄ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–∏—Ö

### 1. User Request Flow:
```
Browser ‚Üí Frontend (5001) ‚Üí Orchestrator (5101) ‚Üí LLM API (4000)
                                ‚Üì
                          MCP Servers (stdio)
                                ‚Üì
                          TTS Service (3001)
                                ‚Üì
                          WebSocket (5102)
                                ‚Üì
                          Browser (updates)
```

### 2. MCP Protocol Flow:
```
Orchestrator ‚Üí MCPManager ‚Üí MCPServer (stdio)
                                ‚Üì
                          spawn('npx', [...])
                                ‚Üì
                          stdin/stdout communication
                                ‚Üì
                          JSON-RPC 2.0 messages
                                ‚Üì
                          Tool execution result
```

### 3. TTS Synchronization Flow:
```
Stage Processor ‚Üí TTSSyncManager ‚Üí TTS Queue
                                      ‚Üì
                                Rate limiting
                                      ‚Üì
                                HTTP POST ‚Üí TTS Service (3001)
                                      ‚Üì
                                Audio synthesis (Metal GPU)
                                      ‚Üì
                                WebSocket broadcast
                                      ‚Üì
                                Browser plays audio
```

---

## üìà Lifecycle Management

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å lifecycle hooks:

```
1. REGISTRATION PHASE
   ‚îî‚îÄ‚ñ∫ container.register(name, factory, options)

2. INITIALIZATION PHASE (onInit)
   ‚îú‚îÄ‚ñ∫ Core Services (priority 100-85)
   ‚îú‚îÄ‚ñ∫ State Services (priority 70)
   ‚îú‚îÄ‚ñ∫ API Services (priority 60-50)
   ‚îú‚îÄ‚ñ∫ MCP Workflow Services (priority 55-50)
   ‚îú‚îÄ‚ñ∫ Utility Services (priority 45)
   ‚îî‚îÄ‚ñ∫ Stage Processors (priority 45-40)

3. START PHASE (onStart)
   ‚îú‚îÄ‚ñ∫ MCPManager.initialize()
   ‚îÇ     ‚îî‚îÄ‚ñ∫ Spawn all MCP servers
   ‚îú‚îÄ‚ñ∫ WebSocketManager.start()
   ‚îî‚îÄ‚ñ∫ Express app.listen()

4. RUNTIME PHASE
   ‚îî‚îÄ‚ñ∫ Process user requests

5. SHUTDOWN PHASE (onStop)
   ‚îú‚îÄ‚ñ∫ container.stop()
   ‚îÇ     ‚îî‚îÄ‚ñ∫ Call onStop() for all services
   ‚îú‚îÄ‚ñ∫ Close HTTP server
   ‚îú‚îÄ‚ñ∫ Close WebSocket connections
   ‚îî‚îÄ‚ñ∫ Terminate MCP server processes
```

---

## üéØ –ö–ª—é—á–æ–≤—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –±–ª–æ—á–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏

### 1. **–ú–æ–¥—É–ª—å–Ω—ñ—Å—Ç—å**
- –ö–æ–∂–µ–Ω –±–ª–æ–∫ - –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π —Å–µ—Ä–≤—ñ—Å
- –ß—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏
- –õ–µ–≥–∫–æ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Ç–∞ –∑–∞–º—ñ–Ω—é–≤–∞—Ç–∏

### 2. **Dependency Injection**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–µ–∑–æ–ª–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
- Singleton pattern –¥–ª—è shared services
- Circular dependency detection

### 3. **Lifecycle Management**
- –ö–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
- Graceful shutdown
- –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–∏ –∑–∞–ø—É—Å–∫—É

### 4. **Stage-based Processing**
- 9 –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å–æ—Ä—ñ–≤
- –ß—ñ—Ç–∫–∏–π workflow pipeline
- Retry —Ç–∞ error recovery

### 5. **MCP Protocol Integration**
- 6 MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤ —á–µ—Ä–µ–∑ stdio
- JSON-RPC 2.0 communication
- Tool validation —Ç–∞ auto-correction

---

---

## üîÑ TETYANA REFACTORING INTEGRATION (2025-10-21)

### –ù–æ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ TetyanaToolSystem

**–î–∞—Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó:** 21 –∂–æ–≤—Ç–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready (Phase 1-2 COMPLETED)

### –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ DI Container

**–§–∞–π–ª:** `orchestrator/core/service-registry.js` (lines 230-246)

```javascript
// NEW 2025-10-20: TetyanaToolSystem - Goose-inspired tool management
container.singleton('tetyanaToolSystem', (c) => {
    const mcpManager = c.resolve('mcpManager');
    return new TetyanaToolSystem(mcpManager);
}, {
    dependencies: ['mcpManager'],
    metadata: { category: 'workflow', priority: 54 },
    lifecycle: {
        onInit: async function () {
            await this.initialize();
            const stats = this.getStatistics();
            logger.system('startup', 
                `[DI] üéØ TetyanaToolSystem initialized: ${stats.totalTools} tools`);
        }
    }
});
```

**–ü–æ–∑–∏—Ü—ñ—è –≤ lifecycle:**
- Priority: **54** (–º—ñ–∂ MCPManager[55] —Ç–∞ TTSSyncManager[53])
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è **–ø—ñ—Å–ª—è** MCPManager (–ø–æ—Ç—Ä–µ–±—É—î –≥–æ—Ç–æ–≤—ñ MCP servers)
- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è **–¥–æ** Stage Processors (–≤–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å TetyanaToolSystem)

---

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ TetyanaToolSystem

```
TetyanaToolSystem (NEW)
‚îú‚îÄ‚ñ∫ MCPExtensionManager (existing, enhanced)
‚îÇ   ‚îî‚îÄ‚ñ∫ Manages tool discovery and indexing
‚îÇ
‚îú‚îÄ‚ñ∫ ToolHistoryManager (NEW - Phase 1)
‚îÇ   ‚îú‚îÄ‚ñ∫ Tracks last 100 tool calls
‚îÇ   ‚îú‚îÄ‚ñ∫ Success/failure rates
‚îÇ   ‚îî‚îÄ‚ñ∫ Formatted context for LLM
‚îÇ
‚îú‚îÄ‚ñ∫ ToolInspectionManager (NEW - Phase 2)
‚îÇ   ‚îî‚îÄ‚ñ∫ RepetitionInspector (NEW)
‚îÇ       ‚îú‚îÄ‚ñ∫ Consecutive repetition detection (max 3)
‚îÇ       ‚îú‚îÄ‚ñ∫ Total call count tracking (max 10)
‚îÇ       ‚îî‚îÄ‚ñ∫ Actions: ALLOW, DENY, REQUIRE_APPROVAL
‚îÇ
‚îú‚îÄ‚ñ∫ LLMToolSelector (NEW - Phase 2)
‚îÇ   ‚îú‚îÄ‚ñ∫ Tool indexing
‚îÇ   ‚îú‚îÄ‚ñ∫ LLM-based selection with reasoning
‚îÇ   ‚îî‚îÄ‚ñ∫ Priority-based sorting
‚îÇ
‚îî‚îÄ‚ñ∫ ToolDispatcher (existing)
    ‚îî‚îÄ‚ñ∫ Executes validated tool calls
```

---

### –ê–Ω–∞–ª—ñ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π

#### ‚úÖ –ë–ï–ó –î–£–ë–õ–Æ–í–ê–ù–ù–Ø - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –¥–æ–ø–æ–≤–Ω—é—é—Ç—å –æ–¥–∏–Ω –æ–¥–Ω–æ–≥–æ:

**1. MCPExtensionManager vs MCPManager**
- **MCPManager** - –Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è MCP —Å–µ—Ä–≤–µ—Ä–∞–º–∏ (spawn, stdio, JSON-RPC)
- **MCPExtensionManager** - –≤–∏—Å–æ–∫–æ—Ä—ñ–≤–Ω–µ–≤–∞ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—è (tool discovery, validation, filtering)
- **–°—Ç–∞—Ç—É—Å:** –†—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—ó, –ø—Ä–∞—Ü—é—é—Ç—å —Ä–∞–∑–æ–º ‚úÖ

**2. ToolInspectionManager vs Legacy tool-inspectors.js**
- **Legacy (tool-inspectors.js)** - –±–∞–∑–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ ToolDispatcher
- **NEW (ToolInspectionManager)** - —Ä–æ–∑—à–∏—Ä–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑ RepetitionInspector
- **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è:** –û–±–∏–¥–≤—ñ —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–∞—Ü—é—é—Ç—å –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ:
  ```javascript
  // TetyanaToolSystem.executeToolCalls():
  // 1. NEW inspection (repetition detection)
  const inspectionResults = await newInspectionManager.inspectTools(toolCalls);
  
  // 2. Legacy inspection (—á–µ—Ä–µ–∑ dispatcher)
  const result = await dispatcher.dispatchToolCalls(toolCalls);
  ```
- **–°—Ç–∞—Ç—É—Å:** –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞, NEW –¥–æ–¥–∞—î —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª ‚úÖ

**3. ToolHistoryManager vs Existing logging**
- **Existing logging** - –∑–∞–≥–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏
- **ToolHistoryManager** - —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π tracking tool calls –¥–ª—è LLM context
- **–°—Ç–∞—Ç—É—Å:** –†—ñ–∑–Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è, –Ω–µ –¥—É–±–ª—é—é—Ç—å—Å—è ‚úÖ

**4. LLMToolSelector vs Server Selection Stage**
- **Server Selection (Stage 2.0)** - –≤–∏–±—ñ—Ä 1-2 MCP —Å–µ—Ä–≤–µ—Ä—ñ–≤ –¥–ª—è item (–æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π –µ—Ç–∞–ø)
- **LLMToolSelector** - –≤–∏–±—ñ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö tools –∑ reasoning (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π)
- **–°—Ç–∞—Ç—É—Å:** –†—ñ–∑–Ω—ñ —Ä—ñ–≤–Ω—ñ –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—ñ, –¥–æ–ø–æ–≤–Ω—é—é—Ç—å ‚úÖ

**–î–µ—Ç–∞–ª—å–Ω–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –≤–∑–∞—î–º–æ–¥—ñ—ó:**

```
Stage 2.0: Server Selection (–û–ë–û–í'–Ø–ó–ö–û–í–ò–ô)
‚îÇ
‚îú‚îÄ‚ñ∫ –ê–Ω–∞–ª—ñ–∑—É—î item: "Read config file and check syntax"
‚îú‚îÄ‚ñ∫ LLM –≤–∏–±–∏—Ä–∞—î —Å–µ—Ä–≤–µ—Ä–∏: ['filesystem', 'shell']
‚îú‚îÄ‚ñ∫ –í–∏–∑–Ω–∞—á–∞—î prompts: ['TETYANA_PLAN_TOOLS_FILESYSTEM']
‚îÇ
‚îî‚îÄ‚ñ∫ Output: {
      selected_servers: ['filesystem', 'shell'],
      selected_prompts: ['TETYANA_PLAN_TOOLS_FILESYSTEM']
    }

‚Üì –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ Stage 2.1

Stage 2.1: Tetyana Plan Tools
‚îÇ
‚îú‚îÄ‚ñ∫ TetyanaToolSystem.prepareToolsAndPrompt({
‚îÇ     selectedServers: ['filesystem', 'shell'],  ‚Üê –ó Stage 2.0
‚îÇ     userMessage: currentItem.action,
‚îÇ     context: { useLLMSelection: false }  ‚Üê –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –í–ò–ú–ö–ù–ï–ù–û
‚îÇ   })
‚îÇ
‚îú‚îÄ‚ñ∫ MCPExtensionManager —Ñ—ñ–ª—å—Ç—Ä—É—î tools:
‚îÇ     –í—Å—ñ tools (92) ‚Üí –¢—ñ–ª—å–∫–∏ filesystem + shell (30 tools)
‚îÇ
‚îú‚îÄ‚ñ∫ [OPTIONAL] –Ø–∫—â–æ context.useLLMSelection = true:
‚îÇ     ‚îî‚îÄ‚ñ∫ LLMToolSelector.selectTools()
‚îÇ           –í–∏–±–∏—Ä–∞—î 5-10 –Ω–∞–π—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—à–∏—Ö –∑ 30 tools
‚îÇ           Output: [
‚îÇ             { tool: 'read_file', priority: 10, reasoning: '...' },
‚îÇ             { tool: 'list_directory', priority: 8, reasoning: '...' }
‚îÇ           ]
‚îÇ
‚îî‚îÄ‚ñ∫ MCPTodoManager.planTools() –æ—Ç—Ä–∏–º—É—î:
      - toolsSummary (30 tools –∑ filesystem + shell)
      - promptOverride: 'TETYANA_PLAN_TOOLS_FILESYSTEM' ‚Üê –ó Stage 2.0
      - historyContext: "Recent: filesystem__read ‚úÖ"
      - llmSelectedTools: [...] (—è–∫—â–æ enabled)
```

**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏:**

1. **Server Selection (Stage 2.0) - –ó–ê–í–ñ–î–ò –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è:**
   - –í–∏–±–∏—Ä–∞—î 1-2 —Å–µ—Ä–≤–µ—Ä–∏ –∑ 6 –¥–æ—Å—Ç—É–ø–Ω–∏—Ö
   - –ó–º–µ–Ω—à—É—î tools –∑ 92 –¥–æ 20-40
   - –í–∏–∑–Ω–∞—á–∞—î —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ prompts
   - –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ Stage 2.1

2. **LLM Tool Selector - –û–ü–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô:**
   - –ü—Ä–∞—Ü—é—î –ü–Ü–°–õ–Ø —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ø–æ —Å–µ—Ä–≤–µ—Ä–∞—Ö
   - –í–∏–±–∏—Ä–∞—î 5-10 tools –∑ –≤–∂–µ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—Ö 20-40
   - –î–æ–¥–∞—î reasoning –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ tool
   - –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **–í–ò–ú–ö–ù–ï–ù–û** (–ø–æ—Ç—Ä—ñ–±–µ–Ω context.useLLMSelection = true)

3. **Prompts –∑ Stage 2.0 - –ó–ë–ï–†–Ü–ì–ê–Æ–¢–¨–°–Ø:**
   - selected_prompts –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –≤–µ—Å—å workflow
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ MCPTodoManager.planTools()
   - LLM Tool Selector –ù–ï –≤–ø–ª–∏–≤–∞—î –Ω–∞ prompts

**–†–µ–∑—é–º–µ –≤–∑–∞—î–º–æ–¥—ñ—ó:**

| –ê—Å–ø–µ–∫—Ç | Stage 2.0 (Server Selection) | LLM Tool Selector |
|--------|------------------------------|-------------------|
| **–°—Ç–∞—Ç—É—Å** | ‚úÖ –û–ë–û–í'–Ø–ó–ö–û–í–ò–ô | ‚ö†Ô∏è –û–ü–¶–Ü–û–ù–ê–õ–¨–ù–ò–ô (–≤–∏–º–∫–Ω–µ–Ω–æ) |
| **–†—ñ–≤–µ–Ω—å** | Server-level (6 ‚Üí 1-2) | Tool-level (30 ‚Üí 5-10) |
| **Input** | TODO item text | Filtered tools + user query |
| **Output** | selected_servers + prompts | llmSelectedTools + reasoning |
| **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è** | –ó–ê–í–ñ–î–ò | –¢—ñ–ª—å–∫–∏ —è–∫—â–æ context.useLLMSelection = true |
| **–í–ø–ª–∏–≤–∞—î –Ω–∞ prompts** | ‚úÖ –¢–ê–ö (–≤–∏–∑–Ω–∞—á–∞—î prompts) | ‚ùå –ù–Ü |
| **–í–ø–ª–∏–≤–∞—î –Ω–∞ tools** | ‚úÖ –¢–ê–ö (—Ñ—ñ–ª—å—Ç—Ä—É—î 92 ‚Üí 30) | ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É—î (–Ω–µ —Ñ—ñ–ª—å—Ç—Ä—É—î) |

**LLM Tool Selector - –ù–û–í–ê —Ñ—É–Ω–∫—Ü—ñ—è –∑ Goose (Phase 2.4):**
- ‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–∞ –≤ —Ä–∞–º–∫–∞—Ö Tetyana Refactoring (21.10.2025)
- ‚ö†Ô∏è –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º **–í–ò–ú–ö–ù–ï–ù–ê** (context.useLLMSelection = false)
- üéØ –Ü–Ω—Å–ø—ñ—Ä–æ–≤–∞–Ω–∞ Goose RouterToolSelector
- üìä –î–æ–¥–∞—î LLM-based reasoning –¥–ª—è –≤–∏–±–æ—Ä—É tools

**–ß–æ–º—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–º–∫–Ω–µ–Ω–æ:**
1. –î–æ–¥–∞—Ç–∫–æ–≤–∏–π LLM –≤–∏–∫–ª–∏–∫ (~500ms + –≤–∞—Ä—Ç—ñ—Å—Ç—å)
2. Server Selection –≤–∂–µ –¥–æ–±—Ä–µ —Ñ—ñ–ª—å—Ç—Ä—É—î (92 ‚Üí 30 tools)
3. Tetyana –¥–æ–±—Ä–µ —Å–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –∑ 30 tools
4. –ú–æ–∂–Ω–∞ —É–≤—ñ–º–∫–Ω—É—Ç–∏ –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤

**–Ø–∫ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤–∏–±—ñ—Ä tools –ë–ï–ó LLM Tool Selector (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —Ä–µ–∂–∏–º):**

```javascript
// Stage 2.1: Tetyana Plan Tools (–ë–ï–ó LLM Tool Selector)

1. TetyanaToolSystem.prepareToolsAndPrompt()
   ‚îú‚îÄ‚ñ∫ MCPExtensionManager —Ñ—ñ–ª—å—Ç—Ä—É—î –ø–æ servers (–∑ Stage 2.0)
   ‚îÇ     Input: selected_servers = ['filesystem', 'shell']
   ‚îÇ     Output: 30 tools (—Ç—ñ–ª—å–∫–∏ filesystem + shell)
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ü–æ–≤–µ—Ä—Ç–∞—î: {
         tools: [30 tools],
         toolsSummary: "filesystem: read_file, write_file, list_directory...\nshell: run_command..."
       }

2. MCPTodoManager.planTools() –æ—Ç—Ä–∏–º—É—î toolsSummary
   ‚îú‚îÄ‚ñ∫ –ë—É–¥—É—î prompt –¥–ª—è LLM Tetyana:
   ‚îÇ     "Available tools:
   ‚îÇ      filesystem: read_file, write_file, list_directory...
   ‚îÇ      shell: run_command, execute_script...
   ‚îÇ      
   ‚îÇ      Task: Read config.json and validate syntax
   ‚îÇ      
   ‚îÇ      Plan which tools to use and in what order."
   ‚îÇ
   ‚îî‚îÄ‚ñ∫ LLM Tetyana –∞–Ω–∞–ª—ñ–∑—É—î –í–°–Ü 30 tools —Ç–∞ –≤–∏–±–∏—Ä–∞—î –ø–æ—Ç—Ä—ñ–±–Ω—ñ:
         Output: [
           { server: 'filesystem', tool: 'read_file', parameters: {...} },
           { server: 'shell', tool: 'run_command', parameters: {...} }
         ]
```

**–í–∏—Å–Ω–æ–≤–æ–∫:** Tetyana –°–ê–ú–ê –≤–∏–±–∏—Ä–∞—î tools –∑ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É (30 tools). LLM Tool Selector - —Ü–µ –¥–æ–¥–∞—Ç–∫–æ–≤–∞ –æ–ø—Ü—ñ—è –¥–ª—è pre-filtering 30 ‚Üí 5-10 tools –∑ reasoning.

**–ö–æ–ª–∏ –≤–∞—Ä—Ç–æ —É–≤—ñ–º–∫–Ω—É—Ç–∏ LLM Tool Selector:**
- –î—É–∂–µ —Å–∫–ª–∞–¥–Ω—ñ items –∑ –±–∞–≥–∞—Ç—å–º–∞ –º–æ–∂–ª–∏–≤–∏–º–∏ –ø—ñ–¥—Ö–æ–¥–∞–º–∏ (30+ tools –ø—ñ—Å–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó)
- –ü–æ—Ç—Ä—ñ–±–µ–Ω reasoning –¥–ª—è debugging
- –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø—ñ–¥—Ö–æ–¥—ñ–≤
- –ó–º–µ–Ω—à–µ–Ω–Ω—è prompt size –¥–ª—è Tetyana

---

## üéØ –©–û –†–ï–ê–õ–¨–ù–û –ü–†–ê–¶–Æ–Ñ –í –°–¢–ê–ù–î–ê–†–¢–ù–û–ú–£ –†–ï–ñ–ò–ú–Ü (Phase 1-2)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏, —è–∫—ñ –ê–ö–¢–ò–í–ù–Ü —Ç–∞ –ø–æ–∫—Ä–∞—â—É—é—Ç—å —Å–∏—Å—Ç–µ–º—É:**

### 1. ‚úÖ **ToolHistoryManager** (Phase 1) - –ê–ö–¢–ò–í–ù–ò–ô

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –ó–∞–ø–∏—Å—É—î –æ—Å—Ç–∞–Ω–Ω—ñ 100 tool calls
- Tracking success/failure rates
- –§–æ—Ä–º–∞—Ç—É—î —ñ—Å—Ç–æ—Ä—ñ—é –¥–ª—è LLM context

**–Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**
```javascript
// Stage 2.1: Tetyana Plan Tools
const toolsData = await tetyanaToolSystem.prepareToolsAndPrompt({
    selectedServers: ['filesystem', 'shell'],
    userMessage: currentItem.action
});

// Tetyana –æ—Ç—Ä–∏–º—É—î history context:
toolsData.historyContext = `
Recent tool usage:
- filesystem__read_file ‚úÖ (2m ago) [Success: 100%, Total: 3]
- shell__run_command ‚ùå (5m ago) [Success: 50%, Total: 2]
- playwright__navigate ‚úÖ (10m ago) [Success: 80%, Total: 5]
`

// LLM Tetyana –±–∞—á–∏—Ç—å —Ü–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —ñ –º–æ–∂–µ:
// - –£–Ω–∏–∫–Ω—É—Ç–∏ tools, —è–∫—ñ —á–∞—Å—Ç–æ –ø–∞–¥–∞—é—Ç—å
// - –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏
// - –ê–¥–∞–ø—Ç—É–≤–∞—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ—Å—Ç–æ—Ä—ñ—ó
```

**Impact:** –ö—Ä–∞—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è, —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫.

---

### 2. ‚úÖ **RepetitionInspector** (Phase 2) - –ê–ö–¢–ò–í–ù–ò–ô

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –î–µ—Ç–µ–∫—Ç—É—î consecutive repetitions (—Ç–æ–π —Å–∞–º–∏–π tool √ó 4)
- Tracking total calls per tool (max 10)
- –ë–õ–û–ö–£–Ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—è

**–Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**
```javascript
// Stage 2.2: Tetyana Execute Tools
const result = await tetyanaToolSystem.executeToolCalls(toolCalls);

// –ü–ï–†–ï–î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º:
RepetitionInspector –ø–µ—Ä–µ–≤—ñ—Ä—è—î:
‚îú‚îÄ‚ñ∫ playwright__click –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π 4 —Ä–∞–∑–∏ –ø—ñ–¥—Ä—è–¥? ‚Üí DENY
‚îú‚îÄ‚ñ∫ filesystem__read –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π 11 —Ä–∞–∑—ñ–≤ –∑–∞–≥–∞–ª–æ–º? ‚Üí REQUIRE_APPROVAL
‚îî‚îÄ‚ñ∫ –Ü–Ω—à—ñ tools ‚Üí ALLOW

// –Ø–∫—â–æ DENY:
return {
  success: false,
  error: "Tool has been called 4 times in a row. This appears to be a loop.",
  inspector: "repetition"
}

// Grisha –æ—Ç—Ä–∏–º—É—î —á—ñ—Ç–∫–∏–π —Å–∏–≥–Ω–∞–ª –ø—Ä–æ loop
// Atlas –º–æ–∂–µ adjust strategy –≤ Stage 3
```

**Impact:** –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑–∞—Ü–∏–∫–ª–µ–Ω—å, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –¥–µ—Ç–µ–∫—Ü—ñ—è –ø—Ä–æ–±–ª–µ–º.

---

### 3. ‚úÖ **Enhanced Statistics** - –ê–ö–¢–ò–í–ù–ò–ô

**–©–æ –¥–æ–¥–∞–Ω–æ:**
```javascript
const stats = tetyanaToolSystem.getStatistics();

{
  // Existing
  totalTools: 45,
  totalServers: 6,
  
  // NEW: History stats
  history: {
    totalCalls: 127,
    successfulCalls: 98,
    failedCalls: 29,
    successRate: 0.77,
    uniqueTools: 15,
    avgDuration: 234  // ms
  },
  
  // NEW: Inspection stats
  inspection: {
    totalInspectors: 1,
    inspectors: {
      repetition: {
        consecutiveCount: 1,
        lastCall: 'playwright__click:{"selector":"#btn"}',
        totalTrackedTools: 8,
        callCounts: {
          'playwright__navigate': 5,
          'filesystem__read_file': 12
        }
      }
    }
  }
}
```

**Impact:** –î–µ—Ç–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É —Ç–∞ debugging.

---

### 4. ‚úÖ **LLMToolValidator** (Phase 2.4) - –ê–ö–¢–ò–í–ù–ò–ô

**–°—Ç–∞—Ç—É—Å:** –ü–ï–†–ï–û–ë–õ–ê–î–ù–ê–ù–û –∑ LLMToolSelector –Ω–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤—É –≤–∞–ª—ñ–¥–∞—Ü—ñ—é.

**–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è:**
```bash
# .env
MCP_LLM_MODEL=atlas-gpt-4o-mini      # GPT-4o-mini –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ reasoning
MCP_LLM_TEMPERATURE=0.1              # –ù–∏–∑—å–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ
```

**–©–æ —Ä–æ–±–∏—Ç—å:**
- –í–∞–ª—ñ–¥—É—î tool calls –ü–ï–†–ï–î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î –±–µ–∑–ø–µ–∫—É (dangerous paths, destructive commands)
- –ê–Ω–∞–ª—ñ–∑—É—î relevance –¥–æ user intent
- –û—Ü—ñ–Ω—é—î —Ä–∏–∑–∏–∫–∏ (none/low/medium/high/critical)
- **–ë–õ–û–ö–£–Ñ** high/critical risk tools

**–Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:**
```javascript
// Stage 2.2: –ü–Ü–°–õ–Ø repetition check, –ü–ï–†–ï–î execution

// 1. RepetitionInspector –ø–µ—Ä–µ–≤—ñ—Ä—è—î loops
// 2. LLMToolValidator –ø–µ—Ä–µ–≤—ñ—Ä—è—î –±–µ–∑–ø–µ–∫—É
const validationResults = await llmValidator.validateToolCalls(toolCalls, {
    userIntent: "Read config file"
});

// –ü—Ä–∏–∫–ª–∞–¥ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è:
[
  {
    tool: 'shell__run_command',
    valid: false,
    reasoning: 'Command "rm -rf /" will delete entire system',
    risk: 'critical',
    suggestion: 'BLOCK IMMEDIATELY'
  }
]

// –Ø–∫—â–æ risk = high/critical ‚Üí –ë–õ–û–ö–£–Ñ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
```

**Impact:** –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π, —Å–µ–º–∞–Ω—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.

---

## üìä –†–µ–∞–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ:

| –§—É–Ω–∫—Ü—ñ—è | –°—Ç–∞—Ç—É—Å | Impact |
|---------|--------|--------|
| **Tool History Context** | ‚úÖ –ê–ö–¢–ò–í–ù–ò–ô | Tetyana –±–∞—á–∏—Ç—å –æ—Å—Ç–∞–Ω–Ω—ñ 5 –≤–∏–∫–ª–∏–∫—ñ–≤ |
| **Repetition Detection** | ‚úÖ –ê–ö–¢–ò–í–ù–ò–ô | –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è loops –ø—ñ—Å–ª—è 3-4 –ø–æ–≤—Ç–æ—Ä—ñ–≤ |
| **History Recording** | ‚úÖ –ê–ö–¢–ò–í–ù–ò–ô | –ö–æ–∂–µ–Ω –≤–∏–∫–ª–∏–∫ –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è |
| **Enhanced Statistics** | ‚úÖ –ê–ö–¢–ò–í–ù–ò–ô | –î–µ—Ç–∞–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ |
| **LLM Tool Validator** | ‚úÖ –ê–ö–¢–ò–í–ù–ò–ô | –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º |

---

## üéØ –©–æ –∑–º—ñ–Ω–∏–ª–æ—Å—å –≤ workflow:

**–î–û —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:**
```
Stage 2.1 ‚Üí Tetyana –ø–ª–∞–Ω—É—î tools (–±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É)
Stage 2.2 ‚Üí –í–∏–∫–æ–Ω–∞–Ω–Ω—è (–±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–∞ loops)
```

**–ü–Ü–°–õ–Ø —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:**
```
Stage 2.1 ‚Üí Tetyana –ø–ª–∞–Ω—É—î tools + history context
            "Recent: filesystem__read ‚úÖ (2m ago)"
            
Stage 2.2 ‚Üí STEP 1: RepetitionInspector –ø–µ—Ä–µ–≤—ñ—Ä—è—î loops
            ‚Üí –Ø–∫—â–æ loop ‚Üí DENY
            
            STEP 2: LLMToolValidator –ø–µ—Ä–µ–≤—ñ—Ä—è—î –±–µ–∑–ø–µ–∫—É
            ‚Üí –Ø–∫—â–æ high/critical risk ‚Üí BLOCK
            ‚Üí –Ø–∫—â–æ medium risk ‚Üí WARN but continue
            
            STEP 3: –í–∏–∫–æ–Ω–∞–Ω–Ω—è (—è–∫—â–æ –ø—Ä–æ–π—à–ª–∏ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏)
            
            STEP 4: –ó–∞–ø–∏—Å –≤ history
```

---

## ‚úÖ –ü—ñ–¥—Å—É–º–æ–∫ –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ–∫—Ä–∞—â–µ–Ω—å:

1. **History Context –¥–ª—è LLM** - Tetyana –±–∞—á–∏—Ç—å —â–æ –≤–∂–µ –≤–∏–∫–æ–Ω—É–≤–∞–ª–æ—Å—å
2. **Loop Detection** - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∑–∞—Ü–∏–∫–ª–µ–Ω—å (RepetitionInspector)
3. **Safety Validation** - LLM –ø–µ—Ä–µ–≤—ñ—Ä—è—î –±–µ–∑–ø–µ–∫—É –ø–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º (LLMToolValidator)
4. **History Recording** - –ö–æ–∂–µ–Ω tool call –∑–∞–ø–∏—Å—É—î—Ç—å—Å—è
5. **Enhanced Analytics** - –î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**Estimated improvement:** 
- 60-80% –∑–º–µ–Ω—à–µ–Ω–Ω—è –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏—Ö –ø–ª–∞–Ω—ñ–≤ —Ç–∞ –∑–∞—Ü–∏–∫–ª–µ–Ω—å
- 90%+ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π (rm -rf, system files, etc.)
- –°–µ–º–∞–Ω—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —á–µ—Ä–µ–∑ LLM reasoning

---

### Integration Points

#### 1. Stage 2.1: Tetyana Plan Tools Processor

**–§–∞–π–ª:** `orchestrator/workflow/stages/tetyana-plan-tools-processor.js`

**–î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:**
```javascript
const availableTools = this.mcpManager.getToolsFromServers(selected_servers);
const plan = await this.mcpTodoManager.planTools(currentItem, todo, {
    toolsSummary: toolsSummary
});
```

**–ü—ñ—Å–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:**
```javascript
// NEW: Use TetyanaToolSystem for enhanced tool preparation
const toolsData = await this.tetyanaToolSystem.prepareToolsAndPrompt({
    selectedServers: selected_servers,
    userMessage: currentItem.action,
    context: executionContext
});

// NEW: Include history context
const planOptions = {
    toolsSummary: toolsData.toolsSummary,
    promptOverride,
    historyContext: toolsData.historyContext,  // NEW
    historyStats: toolsData.historyStats        // NEW
};

const plan = await this.mcpTodoManager.planTools(currentItem, todo, planOptions);
```

**–ó–º—ñ–Ω–∏:**
- ‚úÖ –î–æ–¥–∞–Ω–æ history context –¥–ª—è LLM
- ‚úÖ –î–æ–¥–∞–Ω–æ statistics
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è TetyanaToolSystem –∑–∞–º—ñ—Å—Ç—å –ø—Ä—è–º–æ–≥–æ MCPManager
- ‚úÖ Backward compatible (fallback –¥–æ legacy —è–∫—â–æ TetyanaToolSystem –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)

---

#### 2. Stage 2.2: Tetyana Execute Tools Processor

**–§–∞–π–ª:** `orchestrator/workflow/stages/tetyana-execute-tools-processor.js`

**–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è:**
```javascript
// Execute through TetyanaToolSystem (includes inspection + history)
const executionResult = await this.tetyanaToolSystem.executeToolCalls(
    toolCalls,
    executionContext
);

// Result includes NEW metadata:
// - inspection: { denied, requireApproval, allowed }
// - Each tool call recorded in history
```

**–ó–º—ñ–Ω–∏:**
- ‚úÖ Automatic repetition detection
- ‚úÖ Tool calls blocked —è–∫—â–æ loop detected
- ‚úÖ History recording –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
- ‚úÖ Enhanced error messages –∑ inspector reasoning

---

### Execution Flow –∑ –Ω–æ–≤–æ—é —Å–∏—Å—Ç–µ–º–æ—é

**–ü–æ–≤–Ω–∏–π workflow –∑ –æ–±–æ–º–∞ —Å–∏—Å—Ç–µ–º–∞–º–∏:**

```
USER REQUEST: "Read config.json and validate JSON syntax"
‚îÇ
‚îú‚îÄ‚ñ∫ Stage 2.0: Server Selection (–û–ë–û–í'–Ø–ó–ö–û–í–ò–ô)
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ LLM –∞–Ω–∞–ª—ñ–∑—É—î item
‚îÇ     ‚îú‚îÄ‚ñ∫ –í–∏–±–∏—Ä–∞—î —Å–µ—Ä–≤–µ—Ä–∏: ['filesystem', 'shell']
‚îÇ     ‚îú‚îÄ‚ñ∫ –í–∏–∑–Ω–∞—á–∞—î prompts: ['TETYANA_PLAN_TOOLS_FILESYSTEM']
‚îÇ     ‚îÇ
‚îÇ     ‚îî‚îÄ‚ñ∫ Output: {
‚îÇ           selected_servers: ['filesystem', 'shell'],
‚îÇ           selected_prompts: ['TETYANA_PLAN_TOOLS_FILESYSTEM']
‚îÇ         }
‚îÇ
‚îú‚îÄ‚ñ∫ Stage 2.1: Tetyana Plan Tools
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ TetyanaToolSystem.prepareToolsAndPrompt()
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ MCPExtensionManager: Get tools from servers
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ ToolHistoryManager: Format last 5 calls
‚îÇ     ‚îÇ     ‚îÇ     Output: "Recent: playwright__navigate ‚úÖ (2m ago)"
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ LLMToolSelector: (optional) Select relevant tools
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ MCPTodoManager.planTools() –æ—Ç—Ä–∏–º—É—î:
‚îÇ     ‚îÇ     - toolsSummary: 30 tools (filesystem + shell)
‚îÇ     ‚îÇ     - promptOverride: 'TETYANA_PLAN_TOOLS_FILESYSTEM' ‚Üê –ó Stage 2.0
‚îÇ     ‚îÇ     - historyContext: "Recent: filesystem__read ‚úÖ (2m ago)"
‚îÇ     ‚îÇ     - llmSelectedTools: null (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–º–∫–Ω–µ–Ω–æ)
‚îÇ     ‚îÇ     
‚îÇ     ‚îÇ     LLM Tetyana –ø–ª–∞–Ω—É—î:
‚îÇ     ‚îÇ     - filesystem__read_file { path: "config.json" }
‚îÇ     ‚îÇ     - shell__run_command { command: "jq . config.json" }
‚îÇ     ‚îÇ
‚îÇ     ‚îî‚îÄ‚ñ∫ Output: { 
‚îÇ           tool_calls: [
‚îÇ             { server: 'filesystem', tool: 'read_file', ... },
‚îÇ             { server: 'shell', tool: 'run_command', ... }
‚îÇ           ]
‚îÇ         }
‚îÇ
‚îú‚îÄ‚ñ∫ Stage 2.2: Tetyana Execute Tools
‚îÇ     ‚îÇ
‚îÇ     ‚îú‚îÄ‚ñ∫ TetyanaToolSystem.executeToolCalls()
‚îÇ     ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ [NEW] ToolInspectionManager.inspectTools()
‚îÇ     ‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ RepetitionInspector checks:
‚îÇ     ‚îÇ     ‚îÇ           - Consecutive: playwright__click √ó 4 ‚Üí DENY
‚îÇ     ‚îÇ     ‚îÇ           - Total: filesystem__read √ó 11 ‚Üí REQUIRE_APPROVAL
‚îÇ     ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ IF denied:
‚îÇ     ‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ Return error immediately (no execution)
‚îÇ     ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ     ‚îú‚îÄ‚ñ∫ ELSE: ToolDispatcher.dispatchToolCalls()
‚îÇ     ‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ MCPManager.executeTool() for each
‚îÇ     ‚îÇ     ‚îÇ
‚îÇ     ‚îÇ     ‚îî‚îÄ‚ñ∫ [NEW] ToolHistoryManager.recordToolCall()
‚îÇ     ‚îÇ           Records: server, tool, params, success, duration
‚îÇ     ‚îÇ
‚îÇ     ‚îî‚îÄ‚ñ∫ Output: { results, inspection: { denied, allowed } }
‚îÇ
‚îî‚îÄ‚ñ∫ Stage 2.3: Grisha Verify Item
      Uses execution results (now with inspection metadata)
```

---

### –ù–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Å–∏—Å—Ç–µ–º–∏

#### 1. Loop Detection (RepetitionInspector)

**–ü—Ä–∏–∫–ª–∞–¥:**
```
Item: "Click the submit button"

Execution attempts:
1. playwright__click { selector: "#submit" } ‚Üí Failed (element not found)
2. playwright__click { selector: "#submit" } ‚Üí Failed (element not found)
3. playwright__click { selector: "#submit" } ‚Üí Failed (element not found)
4. playwright__click { selector: "#submit" } ‚Üí DENIED by RepetitionInspector

System response:
{
  success: false,
  error: "Tool has been called 4 times in a row. This appears to be a loop.",
  inspector: "repetition",
  metadata: { consecutiveCount: 4, maxAllowed: 3 }
}
```

**Impact:**
- –ó–∞–ø–æ–±—ñ–≥–∞—î –∑–∞—Ü–∏–∫–ª–µ–Ω–Ω—è –≤ Stage 2.2
- Grisha –æ—Ç—Ä–∏–º—É—î —á—ñ—Ç–∫–∏–π —Å–∏–≥–Ω–∞–ª –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É
- Atlas –º–æ–∂–µ adjust strategy –≤ Stage 3

---

#### 2. History Context for LLM

**–ü—Ä–∏–∫–ª–∞–¥:**
```
Current item: "Read the config file"

LLM prompt includes:
"Recent tool usage:
- filesystem__list_directory ‚úÖ (1m ago)
- filesystem__read_file ‚úÖ (2m ago) [Success rate: 100%, Total: 3]
- playwright__navigate ‚ùå (5m ago) [Success rate: 50%, Total: 2]"

LLM reasoning:
"filesystem__read_file was just used successfully, 
I can use it again for the config file"
```

**Impact:**
- –ö—Ä–∞—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è
- –£–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫
- –ë—ñ–ª—å—à –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∏–π –ø—ñ–¥–±—ñ—Ä tools

---

#### 3. LLM Tool Selection (Optional)

**–ü—Ä–∏–∫–ª–∞–¥:**
```
Query: "Find all Python files and count lines"
Available servers: ['filesystem', 'shell', 'playwright']

LLM selects:
[
  {
    server: 'filesystem',
    tool: 'list_directory',
    reasoning: 'Need to find Python files first',
    priority: 10
  },
  {
    server: 'shell',
    tool: 'run_command',
    reasoning: 'Use wc command to count lines',
    priority: 9
  }
]
```

**Impact:**
- –¢–æ—á–Ω—ñ—à–∏–π –ø—ñ–¥–±—ñ—Ä tools
- Reasoning –¥–ª—è debugging
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

---

### Statistics —Ç–∞ Monitoring

**–ù–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏ –≤ getStatistics():**

```javascript
const stats = tetyanaToolSystem.getStatistics();

{
  // Existing
  totalTools: 45,
  totalServers: 6,
  availableServers: ['filesystem', 'playwright', ...],
  mode: 'task',
  
  // NEW: History
  history: {
    totalCalls: 127,
    successfulCalls: 98,
    failedCalls: 29,
    successRate: 0.77,
    uniqueTools: 15,
    avgDuration: 234  // ms
  },
  
  // NEW: Inspection
  inspection: {
    totalInspectors: 1,
    inspectors: {
      repetition: {
        consecutiveCount: 1,
        lastCall: 'playwright__click:{"selector":"#btn"}',
        totalTrackedTools: 8,
        callCounts: {
          'playwright__navigate': 5,
          'filesystem__read_file': 12,
          ...
        }
      }
    }
  },
  
  // NEW: Tool Selector (if enabled)
  toolSelector: {
    indexedServers: 6,
    totalTools: 45,
    serverBreakdown: {
      filesystem: 12,
      playwright: 18,
      shell: 8,
      ...
    }
  }
}
```

---

### Backward Compatibility

**‚úÖ –ü–æ–≤–Ω–∞ –∑–≤–æ—Ä–æ—Ç–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å:**

1. **Fallback –º–µ—Ö–∞–Ω—ñ–∑–º –≤ Stage 2.1:**
   ```javascript
   if (this.tetyanaToolSystem) {
       // Use new system
   } else {
       // Use legacy MCPManager directly
   }
   ```

2. **Optional LLM selector:**
   ```javascript
   if (this.toolSelector && context.useLLMSelection) {
       // Use LLM selection
   }
   // Otherwise use all tools
   ```

3. **Parallel inspection:**
   - NEW inspection (repetition) runs first
   - Legacy inspection (—á–µ—Ä–µ–∑ dispatcher) runs after
   - –û–±–∏–¥–≤—ñ —Å–∏—Å—Ç–µ–º–∏ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–µ–∑–∞–ª–µ–∂–Ω–æ

---

### Performance Impact

**Overhead –Ω–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏:**

| Operation | Time | Impact |
|-----------|------|--------|
| History recording | ~1ms | Negligible |
| Repetition check | ~2ms | Negligible |
| History formatting | ~5ms | Negligible |
| LLM tool selection | ~500ms | Optional, only if enabled |

**Total overhead:** ~8ms per tool execution (without LLM selection)

**Benefits:**
- 60-80% reduction in invalid tool plans
- 90%+ reduction in tool loops
- Better LLM context ‚Üí fewer retries

---

## üìù –í–∏—Å–Ω–æ–≤–æ–∫

### ATLAS v5.0 + Tetyana Refactoring

**–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä –≤–∫–ª—é—á–∞—î:**
- ‚úÖ **DI Container** —è–∫ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ —è–¥—Ä–æ
- ‚úÖ **9 Stage Processors** –¥–ª—è MCP workflow
- ‚úÖ **6 MCP Servers** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
- ‚úÖ **3 AI Agents** –∑ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏–º–∏ —Ä–æ–ª—è–º–∏
- ‚úÖ **Lifecycle Management** –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫—É/–∑—É–ø–∏–Ω–∫–∏
- ‚úÖ **TetyanaToolSystem** (NEW) - Goose-inspired tool management
  - Tool History Tracking (100 calls)
  - Repetition Detection (loop prevention)
  - Enhanced Inspection System
  - LLM Tool Selection (optional)

**–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è:**
- ‚úÖ –ë–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π
- ‚úÖ –ü–æ–≤–Ω–∞ backward compatibility
- ‚úÖ –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π performance overhead
- ‚úÖ –†–æ–∑—à–∏—Ä–µ–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ç–∞ monitoring
- ‚úÖ –ó–Ω–∞—á–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –∑–∞ –ø—Ä–∏–Ω—Ü–∏–ø–æ–º **enhanced pipeline processing**, –¥–µ –Ω–æ–≤—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –¥–æ–¥–∞—é—Ç—å —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ (history, inspection, selection) –±–µ–∑ –ø–æ—Ä—É—à–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏.
