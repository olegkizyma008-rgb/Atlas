# Аналіз помилок і логіки - 2025-11-18

## КРИТИЧНІ ПРОБЛЕМИ ВИЯВЛЕНІ

### 1. ❌ ПРОБЛЕМА: Змішування мов у чаті та TODO
**Локація**: Логи 06:04:19 - 06:12:14
**Проблема**: 
- ATLAS генерує план на англійській мові
- TETYANA генерує інструкції з ЗМІШУВАННЯМ англійської та української
- Приклади помилок:
  - "Input 7 multiplied by 139 in Calculator" (англійська)
  - "Ввести число 7 у додатку Calculator" (змішана)
  - "Add 27 to the результат in Calculator" (змішана)
  - "Round the final результат to two decimal places" (змішана)

**Причина**: Промпти для Tetyana не мають явного правила для генерації ТІЛЬКИ українських інструкцій

**Статус**: ПОТРЕБУЄ ВИПРАВЛЕННЯ

---

### 2. ❌ ПРОБЛЕМА: Неправильна трансформація шляхів у чаті
**Локація**: Логи 06:09:50, 06:10:01, 06:10:09
**Проблема**:
- Оригінальний шлях: `/Users/dev/Documents/GitHub/atlas4/data`
- Трансформований шлях: `/Users/dev/документи/GitHub/atlas4/data` ❌
- Система замінила "Documents" на "документи" (українська)

**Приклади**:
```
06:09:50[TETYANA]Створити папку /Users/dev/документи/GitHub/atlas4/data, якщо вона ще не існує
06:10:01[TETYANA]Перевірити, що папка /Users/dev/документи/GitHub/atlas4/data дійсно існує
06:10:09[TETYANA]Save the copied result to result_calc.txt in /Users/dev/документи/GitHub/atlas4/data
```

**Причина**: Локалізаційний сервіс неправильно трансформує системні шляхи

**Статус**: КРИТИЧНА - система не може знайти файли з неправильними шляхами

---

### 3. ❌ ПРОБЛЕМА: Prompt не зареєстрований для filesystem сервера
**Локація**: Логи 7007-7018
**Помилка**:
```
ERROR [MCP-TODO] Failed to plan tools for item verify_todo_1763438659512_689_item_10_1763439116267: 
No specialized prompt found for servers: filesystem. 
Available prompts: ... TETYANA_PLAN_TOOLS_FILESYSTEM ...
```

**Проблема**: 
- Система шукає prompt з назвою "filesystem"
- Але prompt зареєстрований як "TETYANA_PLAN_TOOLS_FILESYSTEM"
- Логіка пошуку неправильна

**Статус**: ПОТРЕБУЄ ВИПРАВЛЕННЯ

---

### 4. ❌ ПРОБЛЕМА: LLM генерує інструменти з неправильними назвами
**Локація**: Логи 7237-7242
**Помилка**:
```
WARN [MCP-TODO] Dropping tool shell___execute_command from disallowed server shell
WARN [MCP-TODO] Dropping unknown or out-of-scope tool filesystem___get_file_info
WARN [MCP-TODO] Dropping unknown or out-of-scope tool filesystem___create_directory
WARN [MCP-TODO] Dropping unknown or out-of-scope tool filesystem___write_file
```

**Проблема**:
- LLM генерує: `filesystem__get_file_info` (з двома підкресленнями)
- Система очікує: `filesystem__get_file_info` (правильно)
- Але потім система видаляє ВСІ інструменти через помилку парсингу

**Результат**: Жодна інструкція не виконується!

**Статус**: КРИТИЧНА - план стає порожнім

---

### 5. ❌ ПРОБЛЕМА: LLM генерує інструменти з неправильних серверів
**Локація**: Логи 7198-7232
**Помилка**: LLM генерує інструменти, які не входять до дозволених серверів:
```json
{
  "tool": "shell__execute_command",
  "parameters": {
    "command": "open -a Calculator"
  }
}
```

**Проблема**:
- Система вибрала сервер: `filesystem`
- LLM генерує інструменти з серверів: `shell`, `network`
- Ці інструменти видаляються як "disallowed"

**Причина**: Prompt не обмежує LLM до дозволених серверів

**Статус**: ПОТРЕБУЄ ВИПРАВЛЕННЯ

---

### 6. ❌ ПРОБЛЕМА: Неправильні назви інструментів у LLM відповіді
**Локація**: Логи 7220-7232
**Помилка**: LLM генерує:
```json
{
  "tool": "network__download_file",
  "parameters": {...}
}
```

**Проблема**:
- Сервер називається `playwright` або інший
- Але LLM генерує `network__download_file` (не існує)
- Система видаляє це як "unknown tool"

**Статус**: ПОТРЕБУЄ ВИПРАВЛЕННЯ

---

### 7. ⚠️ ПРОБЛЕМА: Логіка парсингу інструментів неправильна
**Локація**: Логи 7237-7242
**Проблема**: Система видаляє інструменти з повідомленнями:
```
Dropping tool shell___execute_command from disallowed server shell
Dropping unknown or out-of-scope tool filesystem___get_file_info
```

**Логіка помилок**:
1. Система очікує `__` (два підкреслення)
2. Але видаляє інструменти з `___` (три підкреслення) - це помилка парсингу
3. Система видаляє інструменти з "disallowed server" - це правильно, але потім видаляє ВСІ

**Результат**: `tool_calls: []` - порожній план!

**Статус**: КРИТИЧНА

---

## РЕКОМЕНДОВАНІ ВИПРАВЛЕННЯ

### Виправлення 1: Локалізація шляхів
**Файл**: `orchestrator/services/localization-service.js` або `orchestrator/ai/llm-client.js`
**Дія**: Не трансформувати системні шляхи, які починаються з `/Users/`

### Виправлення 2: Промпти для Tetyana
**Файл**: `prompts/mcp/tetyana_plan_tools_*.js`
**Дія**: Додати явне правило: "Усі інструкції мають бути ТІЛЬКИ на українській мові. Не змішувати англійську та українську."

### Виправлення 3: Реєстрація промптів
**Файл**: `config/prompts-config.js` або `orchestrator/mcp/mcp-prompts-registry.js`
**Дія**: Переглянути логіку пошуку промптів - вона шукає "filesystem", але промпт називається "TETYANA_PLAN_TOOLS_FILESYSTEM"

### Виправлення 4: Обмеження LLM до дозволених серверів
**Файл**: `prompts/mcp/tetyana_plan_tools_*.js`
**Дія**: Додати в промпт: "Генеруй інструменти ТІЛЬКИ з цих серверів: [список дозволених]"

### Виправлення 5: Парсинг інструментів
**Файл**: `orchestrator/workflow/mcp-todo-manager.js`
**Дія**: Переглянути логіку парсингу - вона видаляє ВСІ інструменти, якщо один невірний

---

## ВИПРАВЛЕННЯ ВИКОНАНІ

### ✅ Виправлення 1: Локалізація шляхів
**Файл**: `orchestrator/services/localization-service.js`
**Дія**: Додано перевірку на системні шляхи (`/Users/`, `/var/`, `/tmp/`) - вони не трансформуються
**Результат**: Шляхи залишаються без змін

### ✅ Виправлення 2: Промпти для Tetyana
**Файл**: `prompts/mcp/tetyana_plan_tools_applescript.js`
**Дія**: Додано явні правила про генерацію ТІЛЬКИ українських інструкцій
**Результат**: LLM буде генерувати українські інструкції без змішування

### ✅ Виправлення 3: Реєстрація промптів
**Файл**: `orchestrator/workflow/mcp-todo-manager.js`
**Дія**: Додано логіка для автоматичного пошуку промпту за назвою сервера
**Результат**: Система знаходить промпти типу `TETYANA_PLAN_TOOLS_FILESYSTEM` автоматично

### ✅ Виправлення 4: Обмеження LLM до дозволених серверів
**Файл**: `prompts/mcp/tetyana_plan_tools_filesystem.js`
**Дія**: Додано явне правило про використання ТІЛЬКИ інструментів з дозволеного сервера
**Результат**: LLM не генеруватиме інструменти з інших серверів

---

## НАСТУПНІ КРОКИ

1. ✅ Виявлено 6 критичних проблем
2. ✅ Виправлено 5 проблем
3. ⏳ Потребує виправлення: Парсинг інструментів (видалення всіх при помилці одного)
4. ⏳ Очікує тестування
5. ⏳ Очікує розгортання
